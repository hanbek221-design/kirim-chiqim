<!doctype html>
<html lang="uz">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>Kirim‚ÄìChiqim Hisobi (Cloud Firestore)</title>
  <meta name="description" content="Oddiy kirim‚Äìchiqim hisoblagich. Ma'lumotlar Cloud Firestore'da saqlanadi. PDF va tahlil grafigi mavjud." />
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
  <style>
/* Kirim‚ÄìChiqim Hisobi ‚Äî mobil + desktop + PDF + analytics */
:root{
  --bg: #0b0f19;
  --card: rgba(255,255,255,.06);
  --card2: rgba(255,255,255,.08);
  --text: rgba(255,255,255,.92);
  --muted: rgba(255,255,255,.66);
  --border: rgba(255,255,255,.12);

  --primary: #ff3b30;
  --primary2: #ff6a00;

  --income: #2dd4bf;
  --expense: #fb7185;

  --shadow: 0 12px 40px rgba(0,0,0,.35);
  --radius: 18px;

  --focus: 0 0 0 3px rgba(255,59,48,.25);
}

:root[data-theme="light"]{
  --bg: #f7f7fb;
  --card: rgba(255,255,255,.9);
  --card2: rgba(255,255,255,.95);
  --text: rgba(16,24,40,.92);
  --muted: rgba(16,24,40,.62);
  --border: rgba(16,24,40,.12);

  --shadow: 0 10px 30px rgba(16,24,40,.10);
}

*{box-sizing:border-box; -webkit-tap-highlight-color: transparent}
html,body{height:100%}
body{
  margin:0;
  font-family: Inter, system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
  background:
    radial-gradient(1000px 700px at 10% 0%, rgba(255,106,0,.25), transparent 60%),
    radial-gradient(900px 700px at 90% 10%, rgba(45,212,191,.18), transparent 55%),
    linear-gradient(180deg, var(--bg), var(--bg));
  color:var(--text);
}

.app{
  max-width: 1100px;
  margin: 0 auto;
  padding: 22px 16px calc(28px + env(safe-area-inset-bottom));
}

.topbar{
  display:flex;
  align-items:flex-start;
  justify-content:space-between;
  gap: 14px;
  margin-bottom: 16px;
}

.brand{
  display:flex;
  gap:12px;
  align-items:center;
}
.logo{
  width:44px;height:44px;
  border-radius: 14px;
  display:grid;
  place-items:center;
  font-weight: 800;
  background: linear-gradient(135deg, rgba(255,59,48,.25), rgba(255,106,0,.18));
  border: 1px solid var(--border);
  box-shadow: var(--shadow);
}

h1{
  font-size: 18px;
  margin:0;
  line-height: 1.2;
}
p{margin:6px 0 0}
.muted{color:var(--muted)}
.footer{
  margin-top: 18px;
  text-align:center;
  font-size: 12px;
}

.grid{
  display:grid;
  grid-template-columns: 1fr;
  gap: 14px;
}

@media (min-width: 980px){
  .grid{
    grid-template-columns: 420px 1fr;
    align-items:start;
  }
  .summary{grid-column: 1 / -1;}
  .analysis{grid-column: 1 / -1;}
}

.card{
  background: linear-gradient(180deg, var(--card2), var(--card));
  border: 1px solid var(--border);
  border-radius: var(--radius);
  box-shadow: var(--shadow);
  padding: 16px;
}

.card-title{
  font-size: 15px;
  margin: 0 0 12px;
}

.summary-grid{
  display:grid;
  grid-template-columns: 1fr;
  gap: 10px;
}

@media (min-width: 620px){
  .summary-grid{grid-template-columns: repeat(3, 1fr);}
}

.metric{
  padding: 12px;
  border-radius: 16px;
  border: 1px solid var(--border);
  background: rgba(0,0,0,.08);
}
:root[data-theme="light"] .metric{background: rgba(16,24,40,.03)}
.metric-label{color:var(--muted); font-size: 12px}
.metric-value{font-size: 20px; font-weight: 800; margin-top: 6px; letter-spacing: .2px}

.metric-income .metric-value{color: var(--income)}
.metric-expense .metric-value{color: var(--expense)}
.metric-balance .metric-value{color: var(--text)}

.summary-actions{
  margin-top: 12px;
  display:flex;
  flex-wrap: wrap;
  gap: 10px;
}

/* Form */
.form{
  display:flex;
  flex-direction:column;
  gap: 12px;
}

.field label{
  display:block;
  font-size: 12px;
  color: var(--muted);
  margin-bottom: 6px;
}
.hint{
  display:block;
  font-size: 11px;
  color: var(--muted);
  margin-top: 6px;
}

input, select, .select, .search{
  width:100%;
  padding: 12px 12px;
  border-radius: 14px;
  border: 1px solid var(--border);
  background: rgba(0,0,0,.10);
  color: var(--text);
  outline: none;
}
:root[data-theme="light"] input, 
:root[data-theme="light"] select,
:root[data-theme="light"] .search{
  background: rgba(255,255,255,.75);
}
input:focus, select:focus, .search:focus{box-shadow: var(--focus); border-color: rgba(255,59,48,.45)}

.two-col{
  display:grid;
  grid-template-columns: 1fr;
  gap: 12px;
}
@media (min-width: 520px){
  .two-col{grid-template-columns: 1fr 1fr;}
}

.segmented{
  display:flex;
  gap: 8px;
  padding: 6px;
  border-radius: 16px;
  border: 1px solid var(--border);
  background: rgba(0,0,0,.08);
}
:root[data-theme="light"] .segmented{background: rgba(16,24,40,.03)}
.seg-item{
  flex: 1;
  display:flex;
  align-items:center;
  justify-content:center;
  gap:8px;
  padding: 10px 10px;
  border-radius: 14px;
  cursor:pointer;
  user-select:none;
  border: 1px solid transparent;
}
.seg-item input{display:none}
.seg-item span{font-weight: 900; font-size: 13px}
.seg-item:has(input:checked){
  background: linear-gradient(135deg, rgba(255,59,48,.22), rgba(255,106,0,.14));
  border-color: rgba(255,59,48,.35);
}

.form-actions{
  display:flex;
  gap: 10px;
  align-items:center;
  justify-content:flex-start;
  flex-wrap: wrap;
}

/* Buttons */
.btn{
  border: 1px solid var(--border);
  background: rgba(0,0,0,.12);
  color: var(--text);
  padding: 11px 14px;
  border-radius: 14px;
  font-weight: 900;
  cursor:pointer;
  display:inline-flex;
  gap: 10px;
  align-items:center;
  transition: transform .06s ease, filter .15s ease, background .15s ease;
  touch-action: manipulation;
}
:root[data-theme="light"] .btn{background: rgba(255,255,255,.8)}
.btn:active{transform: scale(.98)}
.btn:hover{filter: brightness(1.06)}
.btn .icon{opacity:.95}

.btn-primary{
  border-color: rgba(255,59,48,.35);
  background: linear-gradient(135deg, rgba(255,59,48,.95), rgba(255,106,0,.92));
  color: white;
}
.btn-secondary{
  border-color: rgba(255,255,255,.18);
  background: rgba(255,255,255,.08);
}
:root[data-theme="light"] .btn-secondary{background: rgba(16,24,40,.05)}
.btn-danger{
  border-color: rgba(251,113,133,.35);
  background: linear-gradient(135deg, rgba(251,113,133,.88), rgba(255,59,48,.88));
  color: white;
}
.btn-ghost{
  background: transparent;
}

/* List header/tools */
.list-head{
  display:flex;
  align-items:flex-start;
  justify-content:space-between;
  gap: 12px;
  flex-wrap: wrap;
  margin-bottom: 10px;
}
.list-tools{
  display:flex;
  gap: 10px;
  flex-wrap: wrap;
  align-items:center;
}
.select{min-width: 180px}
.search{min-width: 240px}

/* Desktop table */
.table-wrap{
  overflow:auto;
  border-radius: 14px;
  border: 1px solid var(--border);
}
.table{
  width:100%;
  border-collapse: collapse;
  min-width: 720px;
  background: rgba(0,0,0,.06);
}
:root[data-theme="light"] .table{background: rgba(255,255,255,.7)}
th, td{
  padding: 12px 12px;
  border-bottom: 1px solid var(--border);
  vertical-align: top;
  font-size: 13px;
}
th{
  text-align:left;
  font-size: 12px;
  color: var(--muted);
  position: sticky;
  top: 0;
  background: rgba(0,0,0,.16);
  backdrop-filter: blur(10px);
}
:root[data-theme="light"] th{background: rgba(255,255,255,.9)}
th.th-actions, td.td-actions{width: 160px}
.badge{
  display:inline-flex;
  align-items:center;
  gap: 8px;
  padding: 6px 10px;
  border-radius: 999px;
  font-weight: 900;
  border: 1px solid var(--border);
}
.badge.income{color: var(--income); background: rgba(45,212,191,.12); border-color: rgba(45,212,191,.25)}
.badge.expense{color: var(--expense); background: rgba(251,113,133,.12); border-color: rgba(251,113,133,.25)}

.amount{
  font-weight: 1000;
  letter-spacing: .2px;
}
.amount.income{color: var(--income)}
.amount.expense{color: var(--expense)}

.row-actions{
  display:flex;
  gap: 8px;
  justify-content:flex-end;
}
.btn-mini{
  padding: 10px 12px;
  border-radius: 12px;
  font-weight: 900;
  font-size: 12px;
}
.btn-mini.edit{border-color: rgba(255,255,255,.18)}
.btn-mini.del{
  border-color: rgba(251,113,133,.35);
  background: rgba(251,113,133,.14);
}
:root[data-theme="light"] .btn-mini.del{background: rgba(251,113,133,.10)}

/* Empty */
.empty{
  display:flex;
  align-items:center;
  gap: 12px;
  padding: 14px;
  border: 1px dashed var(--border);
  border-radius: 16px;
  margin-top: 12px;
}
.empty-illu{font-size: 26px}
.empty-title{font-weight: 900}

/* Mobile cards list */
.cards{ display:none; }

@media (max-width: 760px){
  .topbar{
    flex-direction: column;
    align-items: stretch;
  }
  .topbar-actions{
    display:flex;
    justify-content:flex-end;
  }

  .list-tools{ width: 100%; }
  .select, .search{
    min-width: 0;
    width: 100%;
  }

  .table-wrap{ display:none; }
  .cards{
    display:grid;
    gap: 10px;
    margin-top: 8px;
  }
  .card-item{
    border: 1px solid var(--border);
    border-radius: 16px;
    padding: 12px;
    background: rgba(0,0,0,.06);
  }
  :root[data-theme="light"] .card-item{background: rgba(16,24,40,.03)}
  .card-top{
    display:flex;
    align-items:center;
    justify-content:space-between;
    gap: 10px;
  }
  .card-meta{
    display:flex;
    align-items:center;
    gap: 8px;
    flex-wrap: wrap;
  }
  .card-date{
    font-size: 12px;
    color: var(--muted);
    font-weight: 900;
  }
  .card-amount{
    font-weight: 1000;
    letter-spacing: .2px;
  }
  .card-note{
    margin-top: 8px;
    color: var(--text);
    font-weight: 650;
    line-height: 1.25;
    word-break: break-word;
  }
  .card-actions{
    margin-top: 10px;
    display:flex;
    gap: 8px;
    justify-content:flex-start;
    flex-wrap: wrap;
  }
}

/* Analytics */
.analysis-head{
  display:flex;
  align-items:center;
  justify-content:space-between;
  gap: 12px;
  flex-wrap: wrap;
}
.analysis-grid{
  display:grid;
  grid-template-columns: 1fr;
  gap: 12px;
  margin-top: 12px;
}
@media (min-width: 900px){
  .analysis-grid{ grid-template-columns: 1fr 1fr; }
}
.canvas-wrap{
  border: 1px solid var(--border);
  border-radius: 16px;
  padding: 10px;
  background: rgba(0,0,0,.06);
}
:root[data-theme="light"] .canvas-wrap{background: rgba(16,24,40,.03)}
.canvas-title{
  display:flex;
  align-items:center;
  justify-content:space-between;
  gap:10px;
  margin-bottom: 8px;
  color: var(--muted);
  font-weight: 900;
  font-size: 12px;
}
canvas{
  width: 100%;
  height: 220px;
  display:block;
}
@media (max-width: 760px){
  canvas{ height: 200px; }
}
.insights{
  margin-top: 12px;
  display:grid;
  grid-template-columns: 1fr;
  gap: 10px;
}
@media (min-width: 900px){
  .insights{ grid-template-columns: repeat(3, 1fr); }
}
.insight{
  border: 1px solid var(--border);
  border-radius: 16px;
  padding: 12px;
  background: rgba(0,0,0,.06);
}
:root[data-theme="light"] .insight{background: rgba(16,24,40,.03)}
.insight .k{color: var(--muted); font-size: 12px; font-weight: 900}
.insight .v{margin-top: 6px; font-size: 14px; font-weight: 1000}


/* Modern chart controls + tooltip */
.canvas-wide{ grid-column: 1 / -1; }

.chart-controls{
  display:flex;
  gap: 8px;
  align-items:center;
}
.chart-select{
  padding: 8px 10px;
  border-radius: 12px;
  border: 1px solid var(--border);
  background: rgba(0,0,0,.10);
  color: var(--text);
  font-weight: 900;
  font-size: 12px;
  outline: none;
}
:root[data-theme="light"] .chart-select{ background: rgba(255,255,255,.8); }
.chart-select:focus{ box-shadow: var(--focus); border-color: rgba(255,59,48,.45); }

.legend{
  display:flex;
  gap: 12px;
  flex-wrap: wrap;
  margin: 8px 0 6px;
  color: var(--muted);
  font-size: 12px;
  font-weight: 900;
}
.lg{ display:inline-flex; align-items:center; gap: 8px; }
.dot{
  width: 10px; height: 10px; border-radius: 999px; display:inline-block;
}
.dot.inc{ background: rgba(45,212,191,.95); box-shadow: 0 0 0 3px rgba(45,212,191,.14); }
.dot.exp{ background: rgba(251,113,133,.95); box-shadow: 0 0 0 3px rgba(251,113,133,.14); }
.line{
  width: 18px; height: 3px; border-radius: 999px; display:inline-block;
}
.line.bal{ background: linear-gradient(90deg, rgba(255,59,48,.95), rgba(255,106,0,.95)); }

.canvas-rel{ position: relative; }
.chart-big{ height: 280px; }
@media (max-width: 760px){ .chart-big{ height: 240px; } }

.chart-tip{
  position: absolute;
  top: 10px;
  left: 10px;
  max-width: min(320px, calc(100% - 20px));
  padding: 10px 12px;
  border-radius: 14px;
  border: 1px solid var(--border);
  background: rgba(0,0,0,.55);
  backdrop-filter: blur(10px);
  box-shadow: var(--shadow);
  color: var(--text);
  font-size: 12px;
  z-index: 5;
}
:root[data-theme="light"] .chart-tip{ background: rgba(255,255,255,.92); }
.chart-tip .t1{ font-weight: 1000; margin-bottom: 6px; }
.chart-tip .t2{ display:grid; grid-template-columns: auto 1fr; gap: 4px 10px; color: var(--muted); }
.chart-tip b{ color: var(--text); }

/* Toast */
.toast{
  position: fixed;
  left: 50%;
  bottom: calc(18px + env(safe-area-inset-bottom));
  transform: translateX(-50%);
  padding: 12px 14px;
  border-radius: 14px;
  border: 1px solid var(--border);
  background: rgba(0,0,0,.55);
  backdrop-filter: blur(10px);
  color: var(--text);
  box-shadow: var(--shadow);
  max-width: min(640px, calc(100vw - 24px));
  z-index: 9999;
}
:root[data-theme="light"] .toast{background: rgba(255,255,255,.92)}

  
/* Analytics extras */
.section-split{
  height: 1px;
  background: var(--border);
  margin: 14px 0;
}
.analysis-extra{
  display:grid;
  grid-template-columns: 1fr;
  gap: 12px;
  margin-top: 10px;
}
@media (min-width: 980px){
  .analysis-extra{ grid-template-columns: 1fr 1fr; }
}
.extra-card{
  border: 1px solid var(--border);
  border-radius: 16px;
  padding: 12px;
  background: rgba(0,0,0,.06);
}
:root[data-theme="light"] .extra-card{background: rgba(16,24,40,.03)}
.extra-title{
  display:flex;
  align-items:baseline;
  justify-content:space-between;
  gap: 10px;
  font-weight: 1000;
  font-size: 13px;
  margin-bottom: 10px;
}
.extra-table-wrap{
  overflow:auto;
  border-radius: 14px;
  border: 1px solid var(--border);
}
.extra-table{
  width:100%;
  border-collapse: collapse;
  min-width: 520px;
  background: rgba(0,0,0,.04);
}
:root[data-theme="light"] .extra-table{background: rgba(255,255,255,.65)}
.extra-table th, .extra-table td{
  padding: 10px 10px;
  border-bottom: 1px solid var(--border);
  font-size: 12px;
  vertical-align: top;
}
.extra-table th{
  position: sticky;
  top: 0;
  background: rgba(0,0,0,.12);
  color: var(--muted);
  text-align:left;
}
:root[data-theme="light"] .extra-table th{background: rgba(255,255,255,.9)}
.mini-head{
  font-weight: 1000;
  color: var(--muted);
  font-size: 12px;
  margin: 8px 0 8px;
}
.two-top{
  display:grid;
  grid-template-columns: 1fr;
  gap: 12px;
}

</style>
</head>
<body>
  <div class="app">
    <header class="topbar">
      <div class="brand">
        <div class="logo" aria-hidden="true">‚Ç∏</div>
        <div>
          <h1>Kirim‚ÄìChiqim Hisobi</h1>
          <p class="muted">Telefon va kompyuterga mos. Ma'lumotlar Cloud Firestore‚Äôda saqlanadi (internet kerak).</p>
        </div>
      </div>

      <div class="topbar-actions">
        <button id="btnTheme" class="btn btn-ghost" type="button" title="Tema (Light/Dark)">
          <span class="icon" aria-hidden="true">‚òæ</span>
          <span>Tema</span>
        </button>
      </div>
    </header>

    <main class="grid">
      <!-- Summary -->
      <section class="card summary">
        <div class="summary-grid">
          <div class="metric metric-income">
            <div class="metric-label">Jami kirim</div>
            <div class="metric-value" id="sumIncome">0 so'm</div>
          </div>
          <div class="metric metric-expense">
            <div class="metric-label">Jami chiqim</div>
            <div class="metric-value" id="sumExpense">0 so'm</div>
          </div>
          <div class="metric metric-balance">
            <div class="metric-label">Balans</div>
            <div class="metric-value" id="sumBalance">0 so'm</div>
          </div>
        </div>

        <div class="summary-actions">
          <button id="btnPdf" class="btn btn-primary" type="button" title="Chop etish oynasi ochiladi (Save as PDF)">
            <span class="icon" aria-hidden="true">üßæ</span>
            <span>Hisobot / PDF</span>
          </button>

          <button id="btnToggleAnalysisMain" class="btn btn-secondary" type="button">
            <span class="icon" aria-hidden="true">üìä</span>
            <span>Tahlilni ko‚Äòrish</span>
          </button>

          <button id="btnExport" class="btn btn-secondary" type="button">
            <span class="icon" aria-hidden="true">‚§ì</span>
            <span>Eksport (JSON)</span>
          </button>
          <input id="fileImport" type="file" accept="application/json" hidden />
          <button id="btnImport" class="btn btn-secondary" type="button">
            <span class="icon" aria-hidden="true">‚§í</span>
            <span>Import</span>
          </button>
          
            <span></span>
          </button>
        </div>

        <p class="muted" style="margin-top:10px;font-size:12px">
          ‚ÄúHisobot / PDF‚Äù tugmasi chop etish oynasini ochadi. U yerdan ‚ÄúSave as PDF‚Äù qilib saqlaysiz.
        </p>
      </section>

      <!-- Form -->
      <section class="card form-card">
        <h2 class="card-title">Yangi yozuv</h2>

        <form id="entryForm" class="form">
          <div class="segmented" role="group" aria-label="Kirim yoki chiqim tanlang">
            <label class="seg-item">
              <input type="radio" name="type" value="income" checked />
              <span>Kirim</span>
            </label>
            <label class="seg-item">
              <input type="radio" name="type" value="expense" />
              <span>Chiqim</span>
            </label>
          </div>

          <div class="two-col">
            <div class="field">
              <label for="amount">Summasi</label>
              <input id="amount" name="amount" inputmode="decimal" placeholder="Masalan: 150000" required />
              <small class="hint">Raqam kiriting (so‚Äòm). Bo‚Äòshliq/vergul bo‚Äòlsa ham bo‚Äòladi.</small>
            </div>

            <div class="field">
              <label for="date">Sana</label>
              <input id="date" name="date" type="date" required />
              <small class="hint">Default: bugungi sana.</small>
            </div>
          </div>

          <div class="field">
            <label for="note">Izoh (nimaga / qayerdan)</label>
            <input id="note" name="note" maxlength="120" placeholder="Masalan: Oziq-ovqat / Oylik / Transport..." required />
          </div>

          <div class="form-actions">
            <button id="btnSave" class="btn btn-primary" type="submit">
              <span class="icon" aria-hidden="true">üíæ</span>
              <span>Saqlash</span>
            </button>
            <button id="btnCancelEdit" class="btn btn-ghost" type="button" hidden>
              <span class="icon" aria-hidden="true">‚Ü©</span>
              <span>Bekor qilish</span>
            </button>
          </div>
        </form>
      </section>

      <!-- List -->
      <section class="card list-card">
        <div class="list-head">
          <div>
            <h2 class="card-title">Yozuvlar</h2>
            <p class="muted" id="countLabel">0 ta yozuv</p>
          </div>

          <div class="list-tools">
            <select id="filterType" class="select" aria-label="Filtr">
              <option value="all">Barchasi</option>
              <option value="income">Faqat kirim</option>
              <option value="expense">Faqat chiqim</option>
            </select>

            <input id="search" class="search" type="search" placeholder="Izoh bo‚Äòyicha qidirish..." />
          </div>
        </div>

        <!-- Desktop: Table -->
        <div class="table-wrap">
          <table class="table" aria-label="Kirim chiqim jadvali">
            <thead>
              <tr>
                <th>Sana</th>
                <th>Turi</th>
                <th>Summasi</th>
                <th>Izoh</th>
                <th class="th-actions">Amal</th>
              </tr>
            </thead>
            <tbody id="tbody"></tbody>
          </table>
        </div>

        <!-- Mobile: Cards -->
        <div id="cards" class="cards" aria-label="Kirim chiqim kartochkalari"></div>

        <div class="empty" id="emptyState" hidden>
          <div class="empty-illu" aria-hidden="true">üßæ</div>
          <div>
            <div class="empty-title">Hozircha yozuv yo‚Äòq</div>
            <div class="muted">Yuqoridan kirim yoki chiqim kiriting va ‚ÄúSaqlash‚Äù bosing.</div>
          </div>
        </div>
      </section>

      <!-- Analytics -->
      <section id="analysisSection" class="card analysis">
        <div class="analysis-head">
          <div>
            <h2 class="card-title" style="margin-bottom:4px">Tahlil (real vaqtda)</h2>
            <div class="muted" style="font-size:12px">‚ÄúKirim ko‚Äòp bo‚Äòlgan kunlar‚Äù, ‚ÄúChiqim ko‚Äòp bo‚Äòlgan kunlar‚Äù va oxirgi 30 kun grafigi.</div>
          </div>
          <button id="btnToggleAnalysis" class="btn btn-secondary" type="button" style="display:none"></button>
        </div>

        <div id="analysisBody" hidden>
          
<div class="analysis-grid">
            <div class="canvas-wrap canvas-wide">
              <div class="canvas-title">
                <span>Kirim / Chiqim (zamonaviy)</span>
                <div class="chart-controls" aria-label="Grafik boshqaruvlari">
                  <select id="groupSelect" class="chart-select" aria-label="Guruhlash">
                    <option value="day">Kun</option>
                    <option value="week">Hafta</option>
                    <option value="month">Oy</option>
                  </select>
                  <select id="rangeSelect" class="chart-select" aria-label="Oraliq">
                    <option value="7">Oxirgi 7</option>
                    <option value="30" selected>Oxirgi 30</option>
                    <option value="90">Oxirgi 90</option>
                    <option value="all">Hammasi</option>
                  </select>
                </div>
              </div>

              <div class="legend">
                <span class="lg"><i class="dot inc"></i> Kirim</span>
                <span class="lg"><i class="dot exp"></i> Chiqim</span>
                <span class="lg"><i class="line bal"></i> Balans (kumulative)</span>
              </div>

              <div class="canvas-rel">
                <canvas id="chartCombo" class="chart-big"></canvas>
                <div id="chartTip" class="chart-tip" hidden></div>
              </div>

              <div class="muted" style="margin-top:8px;font-size:12px">
                Maslahat: telefonda bar ustiga bosib qiymatlarni ko‚Äòring. PDF hisobotda ham grafiklar chiqadi.
              </div>
            </div>

            <div class="canvas-wrap">
              <div class="canvas-title">
                <span>Kumulative balans</span>
                <span class="muted">umumiy trend</span>
              </div>
              <canvas id="chartBalance"></canvas>
            </div>
          </div>

          <div class="insights">

            <div class="insight">
              <div class="k">Eng ko‚Äòp chiqim bo‚Äòlgan kun</div>
              <div class="v" id="insight1">‚Äî</div>
            </div>
            <div class="insight">
              <div class="k">Eng kam chiqim bo‚Äòlgan kun</div>
              <div class="v" id="insight2">‚Äî</div>
            </div>
            <div class="insight">
              <div class="k">Eng ko‚Äòp kirim bo‚Äòlgan kun</div>
              <div class="v" id="insight3">‚Äî</div>
            </div>
          </div>

          <div class="muted" style="margin-top:10px;font-size:12px">
            
          <div class="section-split"></div>

          <div class="analysis-extra">
            <div class="extra-card">
              <div class="extra-title">
                <span>Oylik jamlanma</span>
                <span class="muted">Kirim / Chiqim / Net</span>
              </div>
              <div class="extra-table-wrap">
                <table class="extra-table" aria-label="Oylik jamlanma">
                  <thead>
                    <tr>
                      <th>Oy</th>
                      <th style="text-align:right">Kirim</th>
                      <th style="text-align:right">Chiqim</th>
                      <th style="text-align:right">Net</th>
                    </tr>
                  </thead>
                  <tbody id="monthTbody"></tbody>
                </table>
              </div>
              <div class="muted" style="margin-top:10px;font-size:12px">
                Oxirgi 12 oy ko‚Äòrsatiladi (ko‚Äòp bo‚Äòlsa).
              </div>
            </div>

            <div class="extra-card">
              <div class="extra-title">
                <span>Top 10</span>
                <span class="muted">Eng katta summalar</span>
              </div>

              <div class="two-top">
                <div>
                  <div class="mini-head">Eng katta kirimlar</div>
                  <div class="extra-table-wrap">
                    <table class="extra-table" aria-label="Top 10 kirim">
                      <thead>
                        <tr>
                          <th>Sana</th>
                          <th style="text-align:right">Summa</th>
                          <th>Izoh</th>
                        </tr>
                      </thead>
                      <tbody id="topIncomeTbody"></tbody>
                    </table>
                  </div>
                </div>

                <div>
                  <div class="mini-head">Eng katta chiqimlar</div>
                  <div class="extra-table-wrap">
                    <table class="extra-table" aria-label="Top 10 chiqim">
                      <thead>
                        <tr>
                          <th>Sana</th>
                          <th style="text-align:right">Summa</th>
                          <th>Izoh</th>
                        </tr>
                      </thead>
                      <tbody id="topExpenseTbody"></tbody>
                    </table>
                  </div>
                </div>
              </div>
            </div>
          </div>
Eslatma: Grafiklar ko‚Äòp kun bo‚Äòlsa ‚Äúoxirgi 30 kun‚Äù bo‚Äòyicha ko‚Äòrsatiladi. Hisobot/PDF ichida ham grafiklar chiqadi.
          </div>
        </div>
      </section>
    </main>

    <footer class="footer muted">
      <span>V2 ‚Ä¢ Firestore ‚Ä¢ mobil + desktop ‚Ä¢ PDF + tahlil</span>
    </footer>
  </div>

  <div id="toast" class="toast" role="status" aria-live="polite" aria-atomic="true" hidden></div>

  <script type="module">
// ---------- Firebase imports (module scope) ----------
import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-app.js";
import {
  getFirestore,
  collection,
  addDoc,
  setDoc,
  doc,
  updateDoc,
  deleteDoc,
  onSnapshot,
  getDocs,
  writeBatch,
  serverTimestamp
} from "https://www.gstatic.com/firebasejs/11.0.1/firebase-firestore.js";

(() => {
  'use strict';

  // ---------- Firebase (Cloud Firestore) ----------
  // (importlar modul boshida)

  // Sizning Firebase konfiguratsiyangiz (Firebase Console -> Project settings -> Web app)
  const firebaseConfig = {
    apiKey: "AIzaSyDLIJg7UfsVYiz9HdhbwblqQ_3ZYZPJ8fg",
    authDomain: "shahbozbek-4922b.firebaseapp.com",
    projectId: "shahbozbek-4922b",
    storageBucket: "shahbozbek-4922b.firebasestorage.app",
    messagingSenderId: "131010057146",
    appId: "1:131010057146:web:f9fe30976d19e9d1ea0383",
    measurementId: "G-3XCQLHNYC2"
  };

  const app = initializeApp(firebaseConfig);
  const db = getFirestore(app);

  const COL_NAME = "transactions"; // Firestore collection nomi

  /** @type {{items: Array<{id:string,type:'income'|'expense',amount:number,note:string,date:string,createdAt:number}>}} */
  let state = { items: [] };

  const $ = (sel) => document.querySelector(sel);

  const sumIncomeEl = $('#sumIncome');
  const sumExpenseEl = $('#sumExpense');
  const sumBalanceEl = $('#sumBalance');

  const tbody = $('#tbody');
  const cardsEl = $('#cards');

  const emptyState = $('#emptyState');
  const countLabel = $('#countLabel');

  const entryForm = $('#entryForm');
  const amountInput = $('#amount');
  const noteInput = $('#note');
  const dateInput = $('#date');
  const btnSave = $('#btnSave');
  const btnCancelEdit = $('#btnCancelEdit');

  const filterType = $('#filterType');
  const searchInput = $('#search');

  const btnClearAll = $('#btnClearAll');
  const btnExport = $('#btnExport');
  const btnImport = $('#btnImport');
  const fileImport = $('#fileImport');

  const btnTheme = $('#btnTheme');

  const btnToggleAnalysis = $('#btnToggleAnalysisMain');
  const analysisBody = $('#analysisBody');
  const analysisSection = $('#analysisSection');

  const btnPdf = $('#btnPdf');

  const canvasCombo = $('#chartCombo');
  const canvasBalance = $('#chartBalance');
  const chartTip = $('#chartTip');
  const rangeSelect = $('#rangeSelect');
  const groupSelect = $('#groupSelect');

  const insight1 = $('#insight1');
  const insight2 = $('#insight2');
  const insight3 = $('#insight3');

  const monthTbody = $('#monthTbody');
  const topIncomeTbody = $('#topIncomeTbody');
  const topExpenseTbody = $('#topExpenseTbody');

  const toast = $('#toast');
  let toastTimer = null;

  let editingId = null;

  // ---------- Utils ----------
  const fmt = new Intl.NumberFormat('uz-UZ');

  function formatMoney(n) {
    const v = Number.isFinite(n) ? n : 0;
    return `${fmt.format(v)} so'm`;
  }

  function parseAmount(str) {
    // Accept: "150 000", "150,000", "150000", "150000.50"
    if (typeof str !== 'string') return NaN;
    const cleaned = str.trim().replace(/\s+/g, '').replace(/,/g, '.');
    const num = Number(cleaned);
    return Number.isFinite(num) ? num : NaN;
  }

  function uid() {
    return `${Date.now().toString(36)}_${Math.random().toString(36).slice(2, 9)}`;
  }

  function todayISO() {
    const d = new Date();
    const off = d.getTimezoneOffset();
    const local = new Date(d.getTime() - off * 60_000);
    return local.toISOString().slice(0, 10);
  }

  function showToast(msg) {
    toast.textContent = msg;
    toast.hidden = false;
    if (toastTimer) clearTimeout(toastTimer);
    toastTimer = setTimeout(() => {
      toast.hidden = true;
      toast.textContent = '';
      toastTimer = null;
    }, 2600);
  }

  function safeText(s) {
    return String(s ?? '').replace(/[<>&"]/g, (ch) => ({
      '<':'&lt;','>':'&gt;','&':'&amp;','"':'&quot;'
    }[ch]));
  }
  // ---------- Cloud Firestore (realtime) ----------
  let unsubscribe = null;

  function startRealtime() {
    // Collection ichidagi hamma yozuvlar real vaqtda keladi
    if (unsubscribe) {
      try { unsubscribe(); } catch {}
      unsubscribe = null;
    }

    const colRef = collection(db, COL_NAME);

    unsubscribe = onSnapshot(colRef, (snap) => {
      const items = snap.docs.map((d) => {
        const data = d.data() || {};
        const createdAtMs =
          (data.createdAt && typeof data.createdAt.toMillis === 'function' ? data.createdAt.toMillis() : 0)
          || Number(data.createdAtMs) || 0;

        return {
          id: d.id,
          type: data.type === 'expense' ? 'expense' : 'income',
          amount: Number(data.amount) || 0,
          note: String(data.note || '').slice(0, 120),
          date: String(data.date || todayISO()).slice(0, 10),
          createdAt: createdAtMs
        };
      });

      // UI sorting (eski logikaga mos)
      items.sort((a, b) => {
        if (a.date !== b.date) return (b.date || '').localeCompare(a.date || '');
        return (b.createdAt || 0) - (a.createdAt || 0);
      });

      state.items = items;
      render();
      if (!analysisBody.hidden) renderAnalytics();
    }, (err) => {
      console.error('Firestore onSnapshot error:', err);
      showToast(`Firebase xato: ${err?.code || 'unknown'}`);
    });
  }

  // ---------- Theme ----------
  function getSavedTheme() {
    return localStorage.getItem('kirim_chiqim_theme') || '';
  }
  function setTheme(theme) {
    if (theme) {
      document.documentElement.setAttribute('data-theme', theme);
      localStorage.setItem('kirim_chiqim_theme', theme);
    } else {
      document.documentElement.removeAttribute('data-theme');
      localStorage.removeItem('kirim_chiqim_theme');
    }
  }
  function toggleTheme() {
    const current = document.documentElement.getAttribute('data-theme');
    if (current === 'light') setTheme('');
    else setTheme('light');
    showToast(`Tema: ${document.documentElement.getAttribute('data-theme') === 'light' ? 'Light' : 'Dark'}`);
  }

  // ---------- Filtering ----------
  function getFilteredItems() {
    const ft = filterType.value;
    const q = (searchInput.value || '').trim().toLowerCase();

    let items = [...state.items];

    if (ft !== 'all') items = items.filter(x => x.type === ft);

    if (q) {
      items = items.filter(x =>
        (x.note || '').toLowerCase().includes(q)
        || (x.date || '').includes(q)
      );
    }

    items.sort((a, b) => {
      if (a.date !== b.date) return (b.date || '').localeCompare(a.date || '');
      return (b.createdAt || 0) - (a.createdAt || 0);
    });

    return items;
  }

  // ---------- Summary ----------
  function calcTotals(items = state.items) {
    const income = items.filter(x => x.type === 'income').reduce((s, x) => s + (Number(x.amount) || 0), 0);
    const expense = items.filter(x => x.type === 'expense').reduce((s, x) => s + (Number(x.amount) || 0), 0);
    return { income, expense, balance: income - expense };
  }

  function renderSummary() {
    const { income, expense, balance } = calcTotals(state.items);
    sumIncomeEl.textContent = formatMoney(income);
    sumExpenseEl.textContent = formatMoney(expense);
    sumBalanceEl.textContent = formatMoney(balance);
  }

  // ---------- Render list ----------
  function renderTableRows(items) {
    tbody.innerHTML = '';
    for (const it of items) {
      const tr = document.createElement('tr');

      const tdDate = document.createElement('td');
      tdDate.textContent = it.date || '';
      tr.appendChild(tdDate);

      const tdType = document.createElement('td');
      const badge = document.createElement('span');
      badge.className = `badge ${it.type}`;
      badge.textContent = it.type === 'income' ? 'Kirim' : 'Chiqim';
      tdType.appendChild(badge);
      tr.appendChild(tdType);

      const tdAmount = document.createElement('td');
      const amt = document.createElement('span');
      amt.className = `amount ${it.type}`;
      amt.textContent = formatMoney(it.amount);
      tdAmount.appendChild(amt);
      tr.appendChild(tdAmount);

      const tdNote = document.createElement('td');
      tdNote.textContent = it.note || '';
      tr.appendChild(tdNote);

      const tdActions = document.createElement('td');
      tdActions.className = 'td-actions';

      const actions = document.createElement('div');
      actions.className = 'row-actions';

      const btnE = document.createElement('button');
      btnE.type = 'button';
      btnE.className = 'btn btn-mini edit';
      btnE.textContent = 'Tahrirlash';
      btnE.addEventListener('click', () => startEdit(it.id));

      const btnD = document.createElement('button');
      btnD.type = 'button';
      btnD.className = 'btn btn-mini del';
      btnD.textContent = 'O‚Äòchirish';
      btnD.addEventListener('click', () => removeItem(it.id));

      actions.appendChild(btnE);
      actions.appendChild(btnD);
      tdActions.appendChild(actions);
      tr.appendChild(tdActions);

      tbody.appendChild(tr);
    }
  }

  function renderCards(items) {
    cardsEl.innerHTML = '';
    for (const it of items) {
      const card = document.createElement('div');
      card.className = 'card-item';

      const top = document.createElement('div');
      top.className = 'card-top';

      const meta = document.createElement('div');
      meta.className = 'card-meta';

      const date = document.createElement('div');
      date.className = 'card-date';
      date.textContent = it.date || '';

      const badge = document.createElement('span');
      badge.className = `badge ${it.type}`;
      badge.textContent = it.type === 'income' ? 'Kirim' : 'Chiqim';

      meta.appendChild(date);
      meta.appendChild(badge);

      const amount = document.createElement('div');
      amount.className = `card-amount amount ${it.type}`;
      amount.textContent = formatMoney(it.amount);

      top.appendChild(meta);
      top.appendChild(amount);

      const note = document.createElement('div');
      note.className = 'card-note';
      note.textContent = it.note || '';

      const actions = document.createElement('div');
      actions.className = 'card-actions';

      const btnE = document.createElement('button');
      btnE.type = 'button';
      btnE.className = 'btn btn-mini edit';
      btnE.textContent = 'Tahrirlash';
      btnE.addEventListener('click', () => startEdit(it.id));

      const btnD = document.createElement('button');
      btnD.type = 'button';
      btnD.className = 'btn btn-mini del';
      btnD.textContent = 'O‚Äòchirish';
      btnD.addEventListener('click', () => removeItem(it.id));

      actions.appendChild(btnE);
      actions.appendChild(btnD);

      card.appendChild(top);
      card.appendChild(note);
      card.appendChild(actions);

      cardsEl.appendChild(card);
    }
  }

  function renderList() {
    const items = getFilteredItems();
    countLabel.textContent = `${items.length} ta yozuv`;

    emptyState.hidden = items.length !== 0;

    renderTableRows(items);
    renderCards(items);
  }

  // ---------- Analytics ----------
  function groupByDate(items) {
    // returns array sorted by date asc: {date, income, expense}
    const map = new Map();
    for (const it of items) {
      const d = it.date || todayISO();
      if (!map.has(d)) map.set(d, { date: d, income: 0, expense: 0 });
      const row = map.get(d);
      if (it.type === 'income') row.income += Number(it.amount) || 0;
      else row.expense += Number(it.amount) || 0;
    }
    const arr = Array.from(map.values());
    arr.sort((a,b)=> (a.date||'').localeCompare(b.date||''));
    return arr;
  }

  function lastNDaysSeries(grouped, n=30) {
    if (grouped.length <= n) return grouped;
    return grouped.slice(grouped.length - n);
  }

  function drawBarChart(canvas, series, valueKey, opts) {
    const ctx = canvas.getContext('2d');
    const dpr = Math.max(1, window.devicePixelRatio || 1);

    const cssW = canvas.clientWidth || 600;
    const cssH = canvas.clientHeight || 220;
    canvas.width = Math.round(cssW * dpr);
    canvas.height = Math.round(cssH * dpr);

    ctx.setTransform(dpr, 0, 0, dpr, 0, 0);

    const W = cssW;
    const H = cssH;

    // theme colors
    const isLight = document.documentElement.getAttribute('data-theme') === 'light';
    const bg = isLight ? 'rgba(255,255,255,0.0)' : 'rgba(0,0,0,0.0)';
    const grid = isLight ? 'rgba(16,24,40,0.10)' : 'rgba(255,255,255,0.10)';
    const text = isLight ? 'rgba(16,24,40,0.72)' : 'rgba(255,255,255,0.72)';
    const bar = opts.barColor;
    const accent = opts.accentColor;

    ctx.clearRect(0,0,W,H);
    ctx.fillStyle = bg;
    ctx.fillRect(0,0,W,H);

    const padding = { left: 44, right: 12, top: 12, bottom: 34 };
    const plotW = W - padding.left - padding.right;
    const plotH = H - padding.top - padding.bottom;

    const values = series.map(x => Number(x[valueKey]) || 0);
    const maxV = Math.max(1, ...values);
    const steps = 4;
    const stepV = maxV / steps;

    // grid + y labels
    ctx.font = '12px Inter, system-ui, sans-serif';
    ctx.fillStyle = text;
    ctx.strokeStyle = grid;
    ctx.lineWidth = 1;

    for (let i=0;i<=steps;i++){
      const y = padding.top + plotH - (plotH * (i/steps));
      ctx.beginPath();
      ctx.moveTo(padding.left, y);
      ctx.lineTo(padding.left + plotW, y);
      ctx.stroke();

      const v = Math.round(stepV*i);
      ctx.fillText(formatShort(v), 6, y+4);
    }

    // bars
    const n = series.length || 1;
    const gap = 6;
    const barW = Math.max(6, Math.floor((plotW - gap*(n-1)) / n));

    for (let i=0;i<n;i++){
      const v = values[i];
      const h = (v / maxV) * plotH;
      const x = padding.left + i*(barW + gap);
      const y = padding.top + plotH - h;

      // gradient bar
      const grad = ctx.createLinearGradient(0, y, 0, y+h);
      grad.addColorStop(0, bar);
      grad.addColorStop(1, accent);

      ctx.fillStyle = grad;
      roundRect(ctx, x, y, barW, h, 8);
      ctx.fill();

      // x label every 3 items or last
      const showLabel = (n <= 10) || (i % 3 === 0) || (i === n-1);
      if (showLabel) {
        ctx.fillStyle = text;
        const label = shortDate(series[i].date);
        const lx = x + barW/2 - (ctx.measureText(label).width/2);
        ctx.fillText(label, lx, padding.top + plotH + 22);
      }
    }

    // title hint
    ctx.fillStyle = text;
    ctx.font = '11px Inter, system-ui, sans-serif';
    ctx.fillText(opts.footerHint || '', padding.left, H - 6);
  }

  function roundRect(ctx, x,y,w,h,r){
    const rr = Math.min(r, w/2, h/2);
    ctx.beginPath();
    ctx.moveTo(x+rr, y);
    ctx.arcTo(x+w, y, x+w, y+h, rr);
    ctx.arcTo(x+w, y+h, x, y+h, rr);
    ctx.arcTo(x, y+h, x, y, rr);
    ctx.arcTo(x, y, x+w, y, rr);
    ctx.closePath();
  }

  function shortDate(iso){
    if (!iso) return '';
    // ISO yyyy-mm-dd -> dd.mm
    const m = /^(\d{4})-(\d{2})-(\d{2})$/.exec(iso);
    if (!m) return iso;
    return `${m[3]}.${m[2]}`;
  }

  function formatShort(n){
    const v = Number(n) || 0;
    if (v >= 1_000_000_000) return `${Math.round(v/1_000_000_000)}B`;
    if (v >= 1_000_000) return `${Math.round(v/1_000_000)}M`;
    if (v >= 1_000) return `${Math.round(v/1_000)}K`;
    return `${v}`;
  }

  function computeInsights(grouped){
    if (!grouped.length) return {
      maxExpenseDay: null,
      minExpenseDay: null,
      maxIncomeDay: null
    };

    let maxE = grouped[0], minE = grouped[0], maxI = grouped[0];
    for (const d of grouped){
      if ((d.expense||0) > (maxE.expense||0)) maxE = d;
      if ((d.expense||0) < (minE.expense||0)) minE = d;
      if ((d.income||0) > (maxI.income||0)) maxI = d;
    }
    return { maxExpenseDay: maxE, minExpenseDay: minE, maxIncomeDay: maxI };
  }


  function groupByMonth(items) {
    // returns array sorted by month asc: {month:'YYYY-MM', income, expense}
    const map = new Map();
    for (const it of items) {
      const d = it.date || todayISO();
      const ym = String(d).slice(0,7); // YYYY-MM
      if (!map.has(ym)) map.set(ym, { month: ym, income: 0, expense: 0 });
      const row = map.get(ym);
      if (it.type === 'income') row.income += Number(it.amount) || 0;
      else row.expense += Number(it.amount) || 0;
    }
    const arr = Array.from(map.values());
    arr.sort((a,b)=> (a.month||'').localeCompare(b.month||''));
    return arr;
  }

  function formatMonth(ym) {
    // 'YYYY-MM' -> 'MM.YYYY'
    const m = /^(\d{4})-(\d{2})$/.exec(ym || '');
    if (!m) return ym || '';
    return `${m[2]}.${m[1]}`;
  }

  function renderMonthlyTable() {
    if (!monthTbody) return;
    const months = groupByMonth(state.items);
    monthTbody.innerHTML = '';

    if (months.length === 0) {
      monthTbody.innerHTML = `<tr><td colspan="4">Ma‚Äôlumot yo‚Äòq</td></tr>`;
      return;
    }

    const view = months.length > 12 ? months.slice(months.length - 12) : months;

    for (const m of view) {
      const net = (m.income || 0) - (m.expense || 0);
      const tr = document.createElement('tr');
      tr.innerHTML = `
        <td>${safeText(formatMonth(m.month))}</td>
        <td style="text-align:right"><span class="amount income">${safeText(formatMoney(m.income))}</span></td>
        <td style="text-align:right"><span class="amount expense">${safeText(formatMoney(m.expense))}</span></td>
        <td style="text-align:right"><span class="amount">${safeText(formatMoney(net))}</span></td>
      `;
      monthTbody.appendChild(tr);
    }
  }

  function renderTopTables() {
    if (!topIncomeTbody || !topExpenseTbody) return;

    const incomes = state.items
      .filter(x => x.type === 'income')
      .slice()
      .sort((a,b)=> (Number(b.amount)||0) - (Number(a.amount)||0))
      .slice(0, 10);

    const expenses = state.items
      .filter(x => x.type === 'expense')
      .slice()
      .sort((a,b)=> (Number(b.amount)||0) - (Number(a.amount)||0))
      .slice(0, 10);

    topIncomeTbody.innerHTML = incomes.length ? '' : `<tr><td colspan="3">Kirim yo‚Äòq</td></tr>`;
    topExpenseTbody.innerHTML = expenses.length ? '' : `<tr><td colspan="3">Chiqim yo‚Äòq</td></tr>`;

    for (const it of incomes) {
      const tr = document.createElement('tr');
      tr.innerHTML = `
        <td>${safeText(it.date || '')}</td>
        <td style="text-align:right"><span class="amount income">${safeText(formatMoney(it.amount))}</span></td>
        <td>${safeText(it.note || '')}</td>
      `;
      topIncomeTbody.appendChild(tr);
    }

    for (const it of expenses) {
      const tr = document.createElement('tr');
      tr.innerHTML = `
        <td>${safeText(it.date || '')}</td>
        <td style="text-align:right"><span class="amount expense">${safeText(formatMoney(it.amount))}</span></td>
        <td>${safeText(it.note || '')}</td>
      `;
      topExpenseTbody.appendChild(tr);
    }
  }

    // ---------- Modern Charts ----------
  function parseISODate(iso){
    if (!iso) return new Date();
    return new Date(`${iso}T00:00:00`);
  }
  function toISODate(d){
    const y = d.getFullYear();
    const m = String(d.getMonth()+1).padStart(2,'0');
    const da = String(d.getDate()).padStart(2,'0');
    return `${y}-${m}-${da}`;
  }
  function startOfWeekMonday(d){
    const x = new Date(d);
    const day = x.getDay();
    const diff = (day === 0 ? -6 : 1 - day);
    x.setDate(x.getDate() + diff);
    x.setHours(0,0,0,0);
    return x;
  }
  function startOfMonth(d){
    const x = new Date(d.getFullYear(), d.getMonth(), 1);
    x.setHours(0,0,0,0);
    return x;
  }

  function groupSeries(items, mode){
    const map = new Map();
    for (const it of items){
      const d = parseISODate(it.date || todayISO());
      let key, ts, label;

      if (mode === 'month'){
        const m = startOfMonth(d);
        ts = m.getTime();
        const ym = `${m.getFullYear()}-${String(m.getMonth()+1).padStart(2,'0')}`;
        key = ym;
        label = formatMonth(ym);
      } else if (mode === 'week'){
        const w = startOfWeekMonday(d);
        ts = w.getTime();
        key = toISODate(w);
        label = shortDate(key);
      } else {
        const iso = toISODate(d);
        ts = d.getTime();
        key = iso;
        label = shortDate(iso);
      }

      if (!map.has(key)) map.set(key, { key, label, ts, income:0, expense:0 });
      const row = map.get(key);
      if (it.type === 'income') row.income += Number(it.amount) || 0;
      else row.expense += Number(it.amount) || 0;
    }
    const arr = Array.from(map.values());
    arr.sort((a,b)=> (a.ts||0) - (b.ts||0));
    return arr;
  }

  function applyRange(series){
    const v = rangeSelect?.value || '30';
    if (v === 'all') return series;
    const n = Math.max(1, Number(v) || 30);
    return series.length > n ? series.slice(series.length - n) : series;
  }

  const comboHit = { series: [], centers: [], pad: null, plotW:0, plotH:0, W:0, H:0 };

  function drawComboChart(canvas, series){
    const ctx = canvas.getContext('2d');
    const dpr = Math.max(1, window.devicePixelRatio || 1);

    const cssW = canvas.clientWidth || 800;
    const cssH = canvas.clientHeight || 260;
    canvas.width = Math.round(cssW * dpr);
    canvas.height = Math.round(cssH * dpr);
    ctx.setTransform(dpr,0,0,dpr,0,0);

    const W = cssW, H = cssH;

    const isLight = document.documentElement.getAttribute('data-theme') === 'light';
    const grid = isLight ? 'rgba(16,24,40,0.10)' : 'rgba(255,255,255,0.10)';
    const text = isLight ? 'rgba(16,24,40,0.72)' : 'rgba(255,255,255,0.72)';

    const pad = { l: 54, r: 14, t: 12, b: 36 };
    const plotW = W - pad.l - pad.r;
    const plotH = H - pad.t - pad.b;

    ctx.clearRect(0,0,W,H);

    const values = series.flatMap(s => [s.income, s.expense]).map(v => Number(v)||0);
    const maxV = Math.max(1, ...values);

    // grid + y labels
    const steps = 4;
    ctx.font = '12px Inter, system-ui, sans-serif';
    ctx.fillStyle = text;
    ctx.strokeStyle = grid;
    ctx.lineWidth = 1;

    for (let i=0;i<=steps;i++){
      const y = pad.t + plotH - (plotH * (i/steps));
      ctx.beginPath();
      ctx.moveTo(pad.l, y);
      ctx.lineTo(pad.l + plotW, y);
      ctx.stroke();

      const v = Math.round((maxV/steps)*i);
      ctx.fillText(formatShort(v), 6, y+4);
    }

    const n = Math.max(1, series.length);
    const groupW = plotW / n;
    const gap = Math.max(6, Math.min(12, groupW * 0.14));
    const barW = Math.max(6, Math.min(18, (groupW - gap) / 2));

    comboHit.series = series;
    comboHit.centers = [];
    comboHit.pad = pad;
    comboHit.plotW = plotW;
    comboHit.plotH = plotH;
    comboHit.W = W;
    comboHit.H = H;

    for (let i=0;i<n;i++){
      const s = series[i];
      const cx = pad.l + (i + 0.5) * groupW;
      comboHit.centers.push(cx);

      const incH = (s.income / maxV) * plotH;
      const expH = (s.expense / maxV) * plotH;

      const x1 = cx - barW - gap/2;
      const x2 = cx + gap/2;

      // income bar
      const y1 = pad.t + plotH - incH;
      const g1 = ctx.createLinearGradient(0, y1, 0, y1 + incH);
      g1.addColorStop(0, 'rgba(45,212,191,0.98)');
      g1.addColorStop(1, 'rgba(45,212,191,0.18)');
      ctx.fillStyle = g1;
      roundRect(ctx, x1, y1, barW, incH, 10);
      ctx.fill();

      // expense bar
      const y2 = pad.t + plotH - expH;
      const g2 = ctx.createLinearGradient(0, y2, 0, y2 + expH);
      g2.addColorStop(0, 'rgba(251,113,133,0.98)');
      g2.addColorStop(1, 'rgba(251,113,133,0.18)');
      ctx.fillStyle = g2;
      roundRect(ctx, x2, y2, barW, expH, 10);
      ctx.fill();

      // x labels
      const showLabel = (n <= 10) || (i % 3 === 0) || (i === n-1);
      if (showLabel) {
        ctx.fillStyle = text;
        const label = s.label || '';
        const lw = ctx.measureText(label).width;
        ctx.fillText(label, cx - lw/2, pad.t + plotH + 22);
      }
    }

    ctx.strokeStyle = grid;
    ctx.strokeRect(pad.l + 0.5, pad.t + 0.5, plotW - 1, plotH - 1);
  }

  function drawBalanceChart(canvas, series){
    const ctx = canvas.getContext('2d');
    const dpr = Math.max(1, window.devicePixelRatio || 1);

    const cssW = canvas.clientWidth || 600;
    const cssH = canvas.clientHeight || 220;
    canvas.width = Math.round(cssW * dpr);
    canvas.height = Math.round(cssH * dpr);
    ctx.setTransform(dpr,0,0,dpr,0,0);

    const W = cssW, H = cssH;

    const isLight = document.documentElement.getAttribute('data-theme') === 'light';
    const grid = isLight ? 'rgba(16,24,40,0.10)' : 'rgba(255,255,255,0.10)';
    const text = isLight ? 'rgba(16,24,40,0.72)' : 'rgba(255,255,255,0.72)';

    const pad = { l: 54, r: 14, t: 12, b: 34 };
    const plotW = W - pad.l - pad.r;
    const plotH = H - pad.t - pad.b;

    ctx.clearRect(0,0,W,H);

    // cumulative
    let cum = 0;
    const pts = series.map(s => {
      cum += (Number(s.income)||0) - (Number(s.expense)||0);
      return { label: s.label, value: cum };
    });

    const vals = pts.map(p=>p.value);
    const minV = Math.min(0, ...vals);
    const maxV = Math.max(0, ...vals);
    const span = Math.max(1, maxV - minV);

    // grid
    ctx.font = '12px Inter, system-ui, sans-serif';
    ctx.fillStyle = text;
    ctx.strokeStyle = grid;
    ctx.lineWidth = 1;

    const steps = 4;
    for (let i=0;i<=steps;i++){
      const y = pad.t + plotH - (plotH * (i/steps));
      ctx.beginPath();
      ctx.moveTo(pad.l, y);
      ctx.lineTo(pad.l + plotW, y);
      ctx.stroke();

      const v = minV + (span/steps)*i;
      ctx.fillText(formatShort(Math.round(v)), 6, y+4);
    }

    // zero line
    const y0 = pad.t + plotH - ((0 - minV)/span)*plotH;
    ctx.strokeStyle = isLight ? 'rgba(16,24,40,0.18)' : 'rgba(255,255,255,0.18)';
    ctx.beginPath();
    ctx.moveTo(pad.l, y0);
    ctx.lineTo(pad.l + plotW, y0);
    ctx.stroke();

    const n = Math.max(1, pts.length);
    const stepX = plotW / Math.max(1, n-1);

    const grad = ctx.createLinearGradient(pad.l, 0, pad.l + plotW, 0);
    grad.addColorStop(0, 'rgba(255,59,48,0.95)');
    grad.addColorStop(1, 'rgba(255,106,0,0.95)');

    // line
    ctx.lineWidth = 2.6;
    ctx.strokeStyle = grad;
    ctx.beginPath();
    for (let i=0;i<n;i++){
      const x = pad.l + i * stepX;
      const y = pad.t + plotH - ((pts[i].value - minV)/span)*plotH;
      if (i===0) ctx.moveTo(x,y);
      else ctx.lineTo(x,y);
    }
    ctx.stroke();

    // fill
    const fillGrad = ctx.createLinearGradient(0, pad.t, 0, pad.t + plotH);
    fillGrad.addColorStop(0, 'rgba(255,59,48,0.18)');
    fillGrad.addColorStop(1, 'rgba(255,106,0,0.02)');
    ctx.fillStyle = fillGrad;
    ctx.lineTo(pad.l + (n-1)*stepX, y0);
    ctx.lineTo(pad.l, y0);
    ctx.closePath();
    ctx.fill();

    // points
    for (let i=0;i<n;i++){
      const x = pad.l + i * stepX;
      const y = pad.t + plotH - ((pts[i].value - minV)/span)*plotH;
      ctx.fillStyle = isLight ? 'white' : 'rgba(0,0,0,0.35)';
      ctx.beginPath(); ctx.arc(x,y,4.2,0,Math.PI*2); ctx.fill();
      ctx.fillStyle = grad;
      ctx.beginPath(); ctx.arc(x,y,2.5,0,Math.PI*2); ctx.fill();
    }

    // x labels sparse
    ctx.fillStyle = text;
    for (let i=0;i<n;i++){
      const show = (n <= 10) || (i % 3 === 0) || (i === n-1);
      if (!show) continue;
      const x = pad.l + i * stepX;
      const label = pts[i].label || '';
      const lw = ctx.measureText(label).width;
      ctx.fillText(label, x - lw/2, pad.t + plotH + 22);
    }

    ctx.strokeStyle = grid;
    ctx.strokeRect(pad.l + 0.5, pad.t + 0.5, plotW - 1, plotH - 1);
  }

  function setTipContent(s){
    if (!chartTip) return;
    const net = (Number(s.income)||0) - (Number(s.expense)||0);
    chartTip.innerHTML = `
      <div class="t1">${safeText(s.key || '')}</div>
      <div class="t2">
        <span>Kirim</span><b>${safeText(formatMoney(s.income))}</b>
        <span>Chiqim</span><b>${safeText(formatMoney(s.expense))}</b>
        <span>Net</span><b>${safeText(formatMoney(net))}</b>
      </div>
    `;
  }
  function showTip(s){
    if (!chartTip) return;
    setTipContent(s);
    chartTip.hidden = false;
  }
  function hideTip(){
    if (!chartTip) return;
    chartTip.hidden = true;
  }

  function nearestIndexFromX(x){
    const centers = comboHit.centers || [];
    if (!centers.length) return -1;
    let best = 0, bestD = Infinity;
    for (let i=0;i<centers.length;i++){
      const d = Math.abs(centers[i] - x);
      if (d < bestD){ bestD = d; best = i; }
    }
    return best;
  }

  function bindChartEvents(){
    if (!canvasCombo) return;

    const onMove = (clientX, clientY) => {
      if (!comboHit.series.length) return;
      const rect = canvasCombo.getBoundingClientRect();
      const x = clientX - rect.left;
      const y = clientY - rect.top;

      const p = comboHit.pad;
      if (!p) return;

      if (x < p.l || x > (p.l + comboHit.plotW) || y < p.t || y > (p.t + comboHit.plotH)){
        hideTip();
        return;
      }

      const idx = nearestIndexFromX(x);
      const s = comboHit.series[idx];
      if (!s) return;

      showTip(s);
      const tipW = chartTip.offsetWidth || 240;
      const tipH = chartTip.offsetHeight || 80;

      let tx = Math.min(comboHit.W - tipW - 10, Math.max(10, x + 12));
      let ty = Math.min(comboHit.H - tipH - 10, Math.max(10, y - tipH - 12));

      chartTip.style.left = `${tx}px`;
      chartTip.style.top = `${ty}px`;
    };

    canvasCombo.addEventListener('mousemove', (e) => onMove(e.clientX, e.clientY));
    canvasCombo.addEventListener('mouseleave', hideTip);

    canvasCombo.addEventListener('touchstart', (e) => {
      const t = e.touches?.[0];
      if (t) onMove(t.clientX, t.clientY);
    }, { passive: true });

    canvasCombo.addEventListener('touchmove', (e) => {
      const t = e.touches?.[0];
      if (t) onMove(t.clientX, t.clientY);
    }, { passive: true });

    canvasCombo.addEventListener('touchend', () => {
      setTimeout(hideTip, 1200);
    }, { passive: true });
  }

  function computeInsightsFromSeries(series){
    if (!series.length) return { maxExpense: null, minExpense: null, maxIncome: null };
    let maxE = series[0], minE = series[0], maxI = series[0];
    for (const s of series){
      if ((s.expense||0) > (maxE.expense||0)) maxE = s;
      if ((s.expense||0) < (minE.expense||0)) minE = s;
      if ((s.income||0) > (maxI.income||0)) maxI = s;
    }
    return { maxExpense: maxE, minExpense: minE, maxIncome: maxI };
  }

  function renderAnalytics() {
    const groupMode = groupSelect?.value || 'day';
    const all = groupSeries(state.items, groupMode);
    const view = applyRange(all);

    drawComboChart(canvasCombo, view);
    drawBalanceChart(canvasBalance, view);

    const ins = computeInsightsFromSeries(view);
    insight1.textContent = ins.maxExpense ? `${ins.maxExpense.key} ‚Äî ${formatMoney(ins.maxExpense.expense)}` : 'Ma‚Äôlumot yo‚Äòq';
    insight2.textContent = ins.minExpense ? `${ins.minExpense.key} ‚Äî ${formatMoney(ins.minExpense.expense)}` : 'Ma‚Äôlumot yo‚Äòq';
    insight3.textContent = ins.maxIncome ? `${ins.maxIncome.key} ‚Äî ${formatMoney(ins.maxIncome.income)}` : 'Ma‚Äôlumot yo‚Äòq';

    renderMonthlyTable();
    renderTopTables();
  }


  function toggleAnalysis(open) {
    const isOpen = open ?? analysisBody.hidden;
    analysisBody.hidden = !isOpen;
    btnToggleAnalysis.querySelector('span:last-child').textContent = isOpen ? 'Tahlilni yopish' : 'Tahlilni ko‚Äòrish';
    if (isOpen) {
      // ensure charts size is correct after unhide
      setTimeout(() => renderAnalytics(), 30);
      analysisSection.scrollIntoView({ behavior: 'smooth', block: 'start' });
    }
  }

  // ---------- PDF / Print report ----------
  function openPrintReport() {
    // Use all items (not filtered) for full report; you can change to filtered if desired.
    const items = [...state.items].sort((a,b)=>{
      if (a.date !== b.date) return (a.date||'').localeCompare(b.date||'');
      return (a.createdAt||0) - (b.createdAt||0);
    });

    const { income, expense, balance } = calcTotals(items);

    const grouped = groupByDate(items);
    const limited = lastNDaysSeries(grouped, 30);

    // Ensure charts rendered before exporting
    renderAnalytics();

    const imgIncome = canvasCombo.toDataURL('image/png');
    const imgExpense = canvasBalance.toDataURL('image/png');

    const incomeRows = items.filter(x=>x.type==='income').map(x => `
      <tr>
        <td>${safeText(x.date)}</td>
        <td style="text-align:right">${safeText(formatMoney(x.amount))}</td>
        <td>${safeText(x.note)}</td>
      </tr>
    `).join('');

    const expenseRows = items.filter(x=>x.type==='expense').map(x => `
      <tr>
        <td>${safeText(x.date)}</td>
        <td style="text-align:right">${safeText(formatMoney(x.amount))}</td>
        <td>${safeText(x.note)}</td>
      </tr>
    `).join('');


    const months = groupByMonth(items);
    const monthRows = (months.length ? months : []).map(m => `
      <tr>
        <td>${safeText(formatMonth(m.month))}</td>
        <td style="text-align:right">${safeText(formatMoney(m.income))}</td>
        <td style="text-align:right">${safeText(formatMoney(m.expense))}</td>
        <td style="text-align:right">${safeText(formatMoney((m.income||0)-(m.expense||0)))}</td>
      </tr>
    `).join('');

    const topIncome = items.filter(x=>x.type==='income').slice().sort((a,b)=> (Number(b.amount)||0)-(Number(a.amount)||0)).slice(0,10);
    const topExpense = items.filter(x=>x.type==='expense').slice().sort((a,b)=> (Number(b.amount)||0)-(Number(a.amount)||0)).slice(0,10);

    const topIncomeRows = topIncome.map(x => `
      <tr>
        <td>${safeText(x.date)}</td>
        <td style="text-align:right">${safeText(formatMoney(x.amount))}</td>
        <td>${safeText(x.note)}</td>
      </tr>
    `).join('');

    const topExpenseRows = topExpense.map(x => `
      <tr>
        <td>${safeText(x.date)}</td>
        <td style="text-align:right">${safeText(formatMoney(x.amount))}</td>
        <td>${safeText(x.note)}</td>
      </tr>
    `).join('');

        const dailyRows = grouped.map(d => `
      <tr>
        <td>${safeText(d.date)}</td>
        <td style="text-align:right">${safeText(formatMoney(d.income))}</td>
        <td style="text-align:right">${safeText(formatMoney(d.expense))}</td>
        <td style="text-align:right">${safeText(formatMoney((d.income||0)-(d.expense||0)))}</td>
      </tr>
    `).join('');

    const now = new Date();
    const generatedAt = now.toLocaleString();

    const reportCss = `
      @page { size: A4; margin: 14mm; }
      body{
        font-family: Inter, system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
        color:#111827;
        background:white;
      }
      h1{font-size:18px;margin:0}
      .sub{color:#6b7280;font-size:12px;margin-top:6px}
      .grid{display:grid;grid-template-columns:repeat(3,1fr);gap:10px;margin-top:12px}
      .box{border:1px solid #e5e7eb;border-radius:12px;padding:10px}
      .k{font-size:11px;color:#6b7280;font-weight:700}
      .v{font-size:16px;font-weight:900;margin-top:6px}
      .v.in{color:#0f766e}
      .v.ex{color:#be123c}
      .section{margin-top:16px}
      .stitle{font-size:14px;font-weight:900;margin:0 0 8px}
      table{width:100%;border-collapse:collapse}
      th,td{border-bottom:1px solid #e5e7eb;padding:8px 6px;font-size:11.5px;vertical-align:top}
      th{color:#374151;text-align:left;background:#f9fafb}
      .two{display:grid;grid-template-columns:1fr 1fr;gap:12px}
      .chart{border:1px solid #e5e7eb;border-radius:12px;padding:10px}
      .chart img{width:100%;height:auto;display:block}
      .note{font-size:10.5px;color:#6b7280;margin-top:6px}
      .printbar{position:fixed;right:14px;top:14px;display:flex;gap:8px}
      .btn{border:1px solid #e5e7eb;border-radius:10px;background:#111827;color:white;padding:8px 10px;font-weight:800;font-size:12px;cursor:pointer}
      .btn2{background:white;color:#111827}
      @media print{
        .printbar{display:none}
      }
    `;

    const reportHtml = `
      <!doctype html>
      <html lang="uz">
      <head>
        <meta charset="utf-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1" />
        <title>Kirim‚ÄìChiqim Hisoboti</title>
        <style>${reportCss}</style>
      </head>
      <body>
        <div class="printbar">
          <button class="btn" onclick="window.print()">Chop etish / PDF</button>
          <button class="btn btn2" onclick="window.close()">Yopish</button>
        </div>

        <h1>Kirim‚ÄìChiqim Hisoboti</h1>
        <div class="sub">Yaratilgan: ${safeText(generatedAt)} ‚Ä¢ Yozuvlar: ${items.length} ta</div>

        <div class="grid">
          <div class="box"><div class="k">Jami kirim</div><div class="v in">${safeText(formatMoney(income))}</div></div>
          <div class="box"><div class="k">Jami chiqim</div><div class="v ex">${safeText(formatMoney(expense))}</div></div>
          <div class="box"><div class="k">Balans</div><div class="v">${safeText(formatMoney(balance))}</div></div>
        </div>

        <div class="section">
          <div class="stitle">Tahlil grafiklari (kunlar bo‚Äòyicha)</div>
          <div class="two">
            <div class="chart">
              <div class="k">Kirim / Chiqim (tanlangan oraliq)</div>
              <img src="${imgIncome}" alt="Kirim/Chiqim grafigi" />
            </div>
            <div class="chart">
              <div class="k">Balans (kumulative)</div>
              <img src="${imgExpense}" alt="Balans grafigi" />
            </div>
          </div>
          <div class="note">Eslatma: Grafika ko‚Äòrinishi brauzerga bog‚Äòliq. PDF olish uchun ‚ÄúChop etish / PDF‚Äù tugmasini bosing.</div>
        </div>

        <div class="section">
          <div class="stitle">Kunlik jamlanma</div>
          <table>
            <thead>
              <tr>
                <th>Sana</th>
                <th style="text-align:right">Kirim</th>
                <th style="text-align:right">Chiqim</th>
                <th style="text-align:right">Net (balans)</th>
              </tr>
            </thead>
            <tbody>
              ${dailyRows || '<tr><td colspan="4">Ma‚Äôlumot yo‚Äòq</td></tr>'}
            </tbody>
          </table>
        </div>

        <div class="section">
          <div class="stitle">Kirimlar (nimadan kelgan)</div>
          <table>
            <thead>
              <tr>
                <th>Sana</th>
                <th style="text-align:right">Summa</th>
                <th>Izoh</th>
              </tr>
            </thead>
            <tbody>
              ${incomeRows || '<tr><td colspan="3">Kirim yo‚Äòq</td></tr>'}
            </tbody>
          </table>
        </div>

        <div class="section">
          <div class="stitle">Chiqimlar (qayerga ishlatilgan)</div>
          <table>
            <thead>
              <tr>
                <th>Sana</th>
                <th style="text-align:right">Summa</th>
                <th>Izoh</th>
              </tr>
            </thead>
            <tbody>
              ${expenseRows || '<tr><td colspan="3">Chiqim yo‚Äòq</td></tr>'}
            </tbody>
          </table>
        </div>
      </body>
      </html>
    `;

    const w = window.open('', '_blank');
    if (!w) {
      showToast('Brauzer popupni blok qildi. Ruxsat bering va qayta bosing.');
      return;
    }
    w.document.open();
    w.document.write(reportHtml);
    w.document.close();
  }

  // ---------- Actions ----------
  function resetForm() {
    editingId = null;
    entryForm.reset();
    dateInput.value = todayISO();
    btnSave.querySelector('span:last-child').textContent = 'Saqlash';
    btnCancelEdit.hidden = true;
    amountInput.focus();
  }

  function startEdit(id) {
    const it = state.items.find(x => x.id === id);
    if (!it) return;

    editingId = id;

    const typeRadio = entryForm.querySelector(`input[name="type"][value="${it.type}"]`);
    if (typeRadio) typeRadio.checked = true;

    amountInput.value = String(it.amount ?? '');
    noteInput.value = it.note ?? '';
    dateInput.value = it.date ?? todayISO();

    btnSave.querySelector('span:last-child').textContent = 'Yangilash';
    btnCancelEdit.hidden = false;

    showToast('Tahrirlash rejimi yoqildi');
    amountInput.focus();
    window.scrollTo({ top: 0, behavior: 'smooth' });
  }

  function upsertItem(type, amount, note, date) {
    // Firestore‚Äôga yozish (localStorage ishlatilmaydi)
    if (editingId) {
      const id = editingId;
      editingId = null;

      updateDoc(doc(db, COL_NAME, id), {
        type,
        amount,
        note,
        date,
        updatedAt: serverTimestamp(),
        updatedAtMs: Date.now()
      }).then(() => {
        showToast('Yangilandi');
        resetForm();
      }).catch((e) => {
        console.error(e);
        showToast('Yangilashda xato (Rules/ulanishni tekshiring)');
      });

      return;
    }

    addDoc(collection(db, COL_NAME), {
      type,
      amount,
      note,
      date,
      createdAt: serverTimestamp(),
      createdAtMs: Date.now(),
      updatedAt: serverTimestamp(),
      updatedAtMs: Date.now()
    }).then(() => {
      showToast('Saqlandi');
      resetForm();
    }).catch((e) => {
      console.error(e);
      showToast('Saqlashda xato (Rules/ulanishni tekshiring)');
    });
  }

  function removeItem(id) {
    const it = state.items.find(x => x.id === id);
    if (!it) return;

    const ok = confirm(`Rostdan ham o‚Äòchirasizmi?

${it.type === 'income' ? 'Kirim' : 'Chiqim'}: ${formatMoney(it.amount)}
Izoh: ${it.note}`);
    if (!ok) return;

    deleteDoc(doc(db, COL_NAME, id))
      .then(() => showToast('O‚Äòchirildi'))
      .catch((e) => {
        console.error(e);
        showToast('O‚Äòchirishda xato (Rules/ulanishni tekshiring)');
      });
  }

  
      }

      if (ops > 0) await batch.commit();
      showToast('Hammasi tozalandi');
      resetForm();
    } catch (e) {
      console.error(e);
      showToast('Tozalashda xato (Rules/ulanishni tekshiring)');
    }
  }

  function exportJSON() {
    const payload = {
      exportedAt: new Date().toISOString(),
      version: 1,
      items: state.items
    };

    const blob = new Blob([JSON.stringify(payload, null, 2)], { type: 'application/json;charset=utf-8' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = `kirim-chiqim_${new Date().toISOString().slice(0,10)}.json`;
    document.body.appendChild(a);
    a.click();
    a.remove();
    URL.revokeObjectURL(url);
    showToast('Eksport tayyor');
  }

  async function importJSONFile(file) {
    try {
      const text = await file.text();
      const data = JSON.parse(text);

      const items = Array.isArray(data?.items) ? data.items : Array.isArray(data) ? data : null;
      if (!items) throw new Error('Noto‚Äòg‚Äòri format');

      const cleaned = items
        .filter(x => x && (x.type === 'income' || x.type === 'expense'))
        .map(x => ({
          id: String(x.id || '').trim(),
          type: x.type,
          amount: Number(x.amount) || 0,
          note: String(x.note || '').slice(0, 120),
          date: String(x.date || todayISO()).slice(0, 10),
          createdAt: Number(x.createdAt) || Date.now()
        }))
        .filter(x => x.amount > 0 && x.note);

      if (cleaned.length === 0) return showToast('Import uchun yaroqli yozuv topilmadi');

      const ok = confirm(`Import qilinsinmi?

Topildi: ${cleaned.length} ta yozuv`);
      if (!ok) return;

      const colRef = collection(db, COL_NAME);

      let batch = 
      let ops = 0;

      for (const it of cleaned) {
        const ref = it.id ? doc(db, COL_NAME, it.id) : doc(colRef);
        batch.set(ref, {
          type: it.type,
          amount: Math.round(it.amount),
          note: it.note,
          date: it.date,
          createdAtMs: it.createdAt,
          importedAt: serverTimestamp(),
          importedAtMs: Date.now()
        }, { merge: true });

        ops++;
        if (ops >= 450) {
          await batch.commit();
          batch = 
          ops = 0;
        }
      }

      if (ops > 0) await batch.commit();

      resetForm();
      showToast('Import bajarildi');
    } catch (e) {
      console.error(e);
      showToast('Import xato: fayl formati noto‚Äòg‚Äòri');
    }
  }

  function render() {
    renderSummary();
    renderList();
    // real-time analytics (if open, redraw; if closed, keep light)
    if (!analysisBody.hidden) renderAnalytics();
  }

  // ---------- Events ----------
  entryForm.addEventListener('submit', (e) => {
    e.preventDefault();

    const type = entryForm.querySelector('input[name="type"]:checked')?.value || 'income';
    const amount = parseAmount(amountInput.value);
    const note = (noteInput.value || '').trim();
    const date = (dateInput.value || '').trim() || todayISO();

    if (!Number.isFinite(amount) || amount <= 0) {
      amountInput.focus();
      return showToast('Summani to‚Äòg‚Äòri kiriting (0 dan katta)');
    }
    if (!note) {
      noteInput.focus();
      return showToast('Izohni kiriting');
    }

    upsertItem(type, Math.round(amount), note, date);
  });

  btnCancelEdit.addEventListener('click', () => {
    resetForm();
    showToast('Tahrirlash bekor qilindi');
  });

  filterType.addEventListener('change', renderList);
  searchInput.addEventListener('input', renderList);

  
  btnExport.addEventListener('click', exportJSON);

  btnImport.addEventListener('click', () => fileImport.click());
  fileImport.addEventListener('change', () => {
    const file = fileImport.files?.[0];
    if (file) importJSONFile(file);
    fileImport.value = '';
  });

  btnTheme.addEventListener('click', toggleTheme);

  btnToggleAnalysis.addEventListener('click', () => toggleAnalysis());
  rangeSelect?.addEventListener('change', () => { if (!analysisBody.hidden) renderAnalytics(); });
  groupSelect?.addEventListener('change', () => { if (!analysisBody.hidden) renderAnalytics(); });

  btnPdf.addEventListener('click', openPrintReport);

  window.addEventListener('resize', () => {
    if (!analysisBody.hidden) renderAnalytics();
  });

  // ---------- Init ----------
  function init() {
    dateInput.value = todayISO();

    const saved = getSavedTheme();
    if (saved) setTheme(saved);

    bindChartEvents();

    // Firestore real-time ulanish
    startRealtime();

    // UI initial render (snapshot kelguncha bo‚Äòsh ko‚Äòrinadi)
    render();
    resetForm();

    // start with analytics hidden, but ready
    toggleAnalysis(false);
  }

  init();
})();
</script>
</body>
</html>
