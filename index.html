<!doctype html>
<html lang="uz">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>Kirim‚ÄìChiqim (Firestore Only + Login)</title>
  <meta name="description" content="Kirim-chiqim hisob. Faqat Firestore. Login: ism + kod. Har login uchun alohida ma'lumot. Real-time, report/print/PDF va zamonaviy grafiklar." />
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">

  <style>
:root{
  --bg: #0b0f19;
  --card: rgba(255,255,255,.06);
  --card2: rgba(255,255,255,.08);
  --text: rgba(255,255,255,.92);
  --muted: rgba(255,255,255,.66);
  --border: rgba(255,255,255,.12);

  --primary: #ff3b30;
  --primary2: #ff6a00;

  --income: #2dd4bf;
  --expense: #fb7185;
  --warn: #fbbf24;

  --shadow: 0 12px 40px rgba(0,0,0,.35);
  --radius: 18px;

  --focus: 0 0 0 3px rgba(255,59,48,.25);
}

:root[data-theme="light"]{
  --bg: #f7f7fb;
  --card: rgba(255,255,255,.9);
  --card2: rgba(255,255,255,.95);
  --text: rgba(16,24,40,.92);
  --muted: rgba(16,24,40,.62);
  --border: rgba(16,24,40,.12);
  --shadow: 0 10px 30px rgba(16,24,40,.10);
}

*{box-sizing:border-box; -webkit-tap-highlight-color: transparent}
html,body{height:100%}
body{
  margin:0;
  font-family: Inter, system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
  background:
    radial-gradient(1000px 700px at 10% 0%, rgba(255,106,0,.25), transparent 60%),
    radial-gradient(900px 700px at 90% 10%, rgba(45,212,191,.18), transparent 55%),
    linear-gradient(180deg, var(--bg), var(--bg));
  color:var(--text);
}

a{color: inherit}

.app{
  max-width: 1180px;
  margin: 0 auto;
  padding: 22px 16px calc(28px + env(safe-area-inset-bottom));
}

.topbar{
  display:flex;
  align-items:flex-start;
  justify-content:space-between;
  gap: 14px;
  margin-bottom: 16px;
}

.brand{display:flex; gap:12px; align-items:center;}
.logo{
  width:44px;height:44px;
  border-radius: 14px;
  display:grid;
  place-items:center;
  font-weight: 900;
  background: linear-gradient(135deg, rgba(255,59,48,.25), rgba(255,106,0,.18));
  border: 1px solid var(--border);
  box-shadow: var(--shadow);
}

h1{font-size: 18px; margin:0; line-height: 1.2;}
p{margin:6px 0 0}
.muted{color:var(--muted)}
.footer{margin-top: 18px; text-align:center; font-size: 12px;}

.grid{
  display:grid;
  grid-template-columns: 1fr;
  gap: 14px;
}

@media (min-width: 980px){
  .grid{grid-template-columns: 440px 1fr; align-items:start;}
  .summary{grid-column: 1 / -1;}
  .analysis{grid-column: 1 / -1;}
  .reporting{grid-column: 1 / -1;}
}

.card{
  background: linear-gradient(180deg, var(--card2), var(--card));
  border: 1px solid var(--border);
  border-radius: var(--radius);
  box-shadow: var(--shadow);
  padding: 16px;
}

.card-title{font-size: 15px; margin: 0 0 12px;}

.summary-grid{display:grid; grid-template-columns: 1fr; gap: 10px;}
@media (min-width: 620px){ .summary-grid{grid-template-columns: repeat(3, 1fr);} }

.metric{
  padding: 12px;
  border-radius: 16px;
  border: 1px solid var(--border);
  background: rgba(0,0,0,.08);
}
:root[data-theme="light"] .metric{background: rgba(16,24,40,.03)}
.metric-label{color:var(--muted); font-size: 12px}
.metric-value{font-size: 20px; font-weight: 900; margin-top: 6px; letter-spacing: .2px}
.metric-income .metric-value{color: var(--income)}
.metric-expense .metric-value{color: var(--expense)}
.metric-balance .metric-value{color: var(--text)}

.summary-actions{
  margin-top: 12px;
  display:flex;
  flex-wrap: wrap;
  gap: 10px;
}

/* Fields */
.form{display:flex; flex-direction:column; gap: 12px;}
.field label{display:block; font-size: 12px; color: var(--muted); margin-bottom: 6px;}
.hint{display:block; font-size: 11px; color: var(--muted); margin-top: 6px;}
input, select, .search{
  width:100%;
  padding: 12px 12px;
  border-radius: 14px;
  border: 1px solid var(--border);
  background: rgba(0,0,0,.10);
  color: var(--text);
  outline: none;
}
:root[data-theme="light"] input, 
:root[data-theme="light"] select,
:root[data-theme="light"] .search{
  background: rgba(255,255,255,.75);
}
input:focus, select:focus, .search:focus{box-shadow: var(--focus); border-color: rgba(255,59,48,.45)}
.two-col{display:grid; grid-template-columns: 1fr; gap: 12px;}
@media (min-width: 520px){ .two-col{grid-template-columns: 1fr 1fr;} }

.segmented{
  display:flex;
  gap: 8px;
  padding: 6px;
  border-radius: 16px;
  border: 1px solid var(--border);
  background: rgba(0,0,0,.08);
}
:root[data-theme="light"] .segmented{background: rgba(16,24,40,.03)}
.seg-item{
  flex: 1;
  display:flex;
  align-items:center;
  justify-content:center;
  gap:8px;
  padding: 10px 10px;
  border-radius: 14px;
  cursor:pointer;
  user-select:none;
  border: 1px solid transparent;
}
.seg-item input{display:none}
.seg-item span{font-weight: 950; font-size: 13px}
.seg-item:has(input:checked){
  background: linear-gradient(135deg, rgba(255,59,48,.22), rgba(255,106,0,.14));
  border-color: rgba(255,59,48,.35);
}

.form-actions{display:flex; gap: 10px; align-items:center; justify-content:flex-start; flex-wrap: wrap;}

/* Buttons */
.btn{
  border: 1px solid var(--border);
  background: rgba(0,0,0,.12);
  color: var(--text);
  padding: 11px 14px;
  border-radius: 14px;
  font-weight: 950;
  cursor:pointer;
  display:inline-flex;
  gap: 10px;
  align-items:center;
  transition: transform .06s ease, filter .15s ease, background .15s ease;
  touch-action: manipulation;
}
:root[data-theme="light"] .btn{background: rgba(255,255,255,.8)}
.btn:active{transform: scale(.98)}
.btn:hover{filter: brightness(1.06)}
.btn .icon{opacity:.95}
.btn-primary{
  border-color: rgba(255,59,48,.35);
  background: linear-gradient(135deg, rgba(255,59,48,.95), rgba(255,106,0,.92));
  color: white;
}
.btn-secondary{
  border-color: rgba(255,255,255,.18);
  background: rgba(255,255,255,.08);
}
:root[data-theme="light"] .btn-secondary{background: rgba(16,24,40,.05)}
.btn-danger{
  border-color: rgba(251,113,133,.35);
  background: linear-gradient(135deg, rgba(251,113,133,.88), rgba(255,59,48,.88));
  color: white;
}
.btn-ghost{background: transparent;}
.btn-mini{padding: 10px 12px; border-radius: 12px; font-weight: 950; font-size: 12px;}
.btn[disabled]{opacity:.55; cursor:not-allowed}

/* List header/tools */
.list-head{
  display:flex;
  align-items:flex-start;
  justify-content:space-between;
  gap: 12px;
  flex-wrap: wrap;
  margin-bottom: 10px;
}
.list-tools{
  display:flex;
  gap: 10px;
  flex-wrap: wrap;
  align-items:center;
}
.select{min-width: 180px}
.search{min-width: 240px}

/* Desktop table */
.table-wrap{
  overflow:auto;
  border-radius: 14px;
  border: 1px solid var(--border);
}
.table{
  width:100%;
  border-collapse: collapse;
  min-width: 920px;
  background: rgba(0,0,0,.06);
}
:root[data-theme="light"] .table{background: rgba(255,255,255,.7)}
th, td{
  padding: 12px 12px;
  border-bottom: 1px solid var(--border);
  vertical-align: top;
  font-size: 13px;
}
th{
  text-align:left;
  font-size: 12px;
  color: var(--muted);
  position: sticky;
  top: 0;
  background: rgba(0,0,0,.16);
  backdrop-filter: blur(10px);
}
:root[data-theme="light"] th{background: rgba(255,255,255,.9)}
th.th-actions, td.td-actions{width: 200px}
.badge{
  display:inline-flex;
  align-items:center;
  gap: 8px;
  padding: 6px 10px;
  border-radius: 999px;
  font-weight: 950;
  border:  1px solid var(--border);
  white-space: nowrap;
}
.badge.income{color: var(--income); background: rgba(45,212,191,.12); border-color: rgba(45,212,191,.25)}
.badge.expense{color: var(--expense); background: rgba(251,113,133,.12); border-color: rgba(251,113,133,.25)}
.badge.cat{color: var(--text); background: rgba(255,255,255,.06);}
:root[data-theme="light"] .badge.cat{background: rgba(16,24,40,.04)}
.amount{font-weight: 1000; letter-spacing: .2px;}
.amount.income{color: var(--income)}
.amount.expense{color: var(--expense)}

.row-actions{display:flex; gap: 8px; justify-content:flex-end;}
.btn-mini.del{border-color: rgba(251,113,133,.35); background: rgba(251,113,133,.14);}
:root[data-theme="light"] .btn-mini.del{background: rgba(251,113,133,.10)}

/* Empty */
.empty{
  display:flex;
  align-items:center;
  gap: 12px;
  padding: 14px;
  border: 1px dashed var(--border);
  border-radius: 16px;
  margin-top: 12px;
}
.empty-illu{font-size: 26px}
.empty-title{font-weight: 950}

/* Mobile cards */
.cards{display:none;}
@media (max-width: 800px){
  .topbar{flex-direction: column; align-items: stretch;}
  .topbar-actions{display:flex; justify-content:flex-end; gap: 10px; flex-wrap: wrap;}
  .list-tools{ width: 100%; }
  .select, .search{ min-width: 0; width: 100%; }
  .table-wrap{ display:none; }
  .cards{ display:grid; gap: 10px; margin-top: 8px; }
  .card-item{
    border: 1px solid var(--border);
    border-radius: 16px;
    padding: 12px;
    background: rgba(0,0,0,.06);
  }
  :root[data-theme="light"] .card-item{background: rgba(16,24,40,.03)}
  .card-top{display:flex; align-items:center; justify-content:space-between; gap: 10px;}
  .card-meta{display:flex; align-items:center; gap: 8px; flex-wrap: wrap;}
  .card-date{font-size: 12px; color: var(--muted); font-weight: 950;}
  .card-amount{font-weight: 1000; letter-spacing: .2px;}
  .card-note{margin-top: 8px; color: var(--text); font-weight: 650; line-height: 1.25; word-break: break-word;}
  .card-actions{margin-top: 10px; display:flex; gap: 8px; justify-content:flex-start; flex-wrap: wrap;}
}

/* Analytics */
.analysis{display:none}
.analysis.open{display:block}
.analysis-head{display:flex; align-items:center; justify-content:space-between; gap: 12px; flex-wrap: wrap;}
.analysis-grid{display:grid; grid-template-columns: 1fr; gap: 12px; margin-top: 12px;}
@media (min-width: 900px){ .analysis-grid{ grid-template-columns: 1fr 1fr; } }

.canvas-wrap{
  border: 1px solid var(--border);
  border-radius: 16px;
  padding: 10px;
  background: rgba(0,0,0,.06);
  position: relative;
}
:root[data-theme="light"] .canvas-wrap{background: rgba(16,24,40,.03)}
.canvas-title{display:flex; align-items:center; justify-content:space-between; gap:10px; margin-bottom: 8px; color: var(--muted); font-weight: 950; font-size: 12px;}
canvas{width: 100%; height: 260px; display:block;}
@media (max-width: 800px){ canvas{ height: 220px; } }

.insights{margin-top: 12px; display:grid; grid-template-columns: 1fr; gap: 10px;}
@media (min-width: 900px){ .insights{ grid-template-columns: repeat(3, 1fr); } }
.insight{border: 1px solid var(--border); border-radius: 16px; padding: 12px; background: rgba(0,0,0,.06);}
:root[data-theme="light"] .insight{background: rgba(16,24,40,.03)}
.insight .k{color: var(--muted); font-size: 12px; font-weight: 950}
.insight .v{margin-top: 6px; font-size: 14px; font-weight: 1000}

/* Report settings */
.pillrow{display:flex; flex-wrap:wrap; gap: 8px; margin-top: 10px;}
.pill{
  border: 1px solid var(--border);
  border-radius: 999px;
  padding: 8px 10px;
  background: rgba(0,0,0,.08);
  font-weight: 900;
  font-size: 12px;
}
:root[data-theme="light"] .pill{background: rgba(16,24,40,.03)}
.switch{
  display:flex;
  align-items:center;
  gap: 10px;
  padding: 10px 12px;
  border: 1px solid var(--border);
  border-radius: 14px;
  background: rgba(0,0,0,.06);
}
:root[data-theme="light"] .switch{background: rgba(16,24,40,.03)}
.switch input{width: 20px; height: 20px; margin:0;}
.small-actions{display:flex; gap: 10px; flex-wrap:wrap; align-items:center; margin-top: 10px;}
.hr{height:1px; background: var(--border); margin: 12px 0}

/* Toast */
.toast{
  position: fixed;
  left: 50%;
  bottom: calc(18px + env(safe-area-inset-bottom));
  transform: translateX(-50%);
  padding: 12px 14px;
  border-radius: 14px;
  border: 1px solid var(--border);
  background: rgba(0,0,0,.55);
  backdrop-filter: blur(10px);
  color: var(--text);
  box-shadow: var(--shadow);
  max-width: min(680px, calc(100vw - 24px));
  z-index: 9999;
}
:root[data-theme="light"] .toast{background: rgba(255,255,255,.92)}

/* Login overlay */
.overlay{
  position: fixed;
  inset: 0;
  background: radial-gradient(900px 700px at 20% 0%, rgba(255,106,0,.25), transparent 60%),
              radial-gradient(900px 700px at 80% 10%, rgba(45,212,191,.20), transparent 55%),
              rgba(0,0,0,.72);
  backdrop-filter: blur(14px);
  display:flex;
  align-items:center;
  justify-content:center;
  padding: 18px;
  z-index: 10000;
}
.overlay.hidden{display:none}
.login-card{
  width: min(520px, 100%);
  border: 1px solid var(--border);
  border-radius: 22px;
  box-shadow: var(--shadow);
  background: linear-gradient(180deg, var(--card2), var(--card));
  padding: 16px;
}
.login-head{display:flex; align-items:center; gap:12px; margin-bottom: 10px;}
.login-head .lgo{width:44px;height:44px;border-radius:14px;display:grid;place-items:center;font-weight:900;border:1px solid var(--border);background:linear-gradient(135deg, rgba(255,59,48,.25), rgba(255,106,0,.18));}
.login-title{margin:0;font-size:16px}
.login-sub{margin:6px 0 0; font-size:12px; color: var(--muted); line-height: 1.35;}
.login-actions{display:flex; gap:10px; flex-wrap:wrap; margin-top: 12px;}
.login-note{margin-top:10px; font-size:11px; color: var(--muted); line-height:1.35;}
.inline-badge{
  display:inline-flex; align-items:center; gap:8px;
  border: 1px solid var(--border);
  border-radius: 999px;
  padding: 6px 10px;
  font-weight: 900;
  font-size: 12px;
  background: rgba(255,255,255,.06);
}
.statbar{
  display:flex; align-items:center; gap: 10px; flex-wrap:wrap; justify-content:flex-end;
}
.dotlive{
  width:10px;height:10px;border-radius:50%;
  background: rgba(251,191,36,.85);
  box-shadow: 0 0 0 4px rgba(251,191,36,.10);
}
.dotlive.ok{background: rgba(45,212,191,.9); box-shadow: 0 0 0 4px rgba(45,212,191,.10);}
.dotlive.bad{background: rgba(251,113,133,.9); box-shadow: 0 0 0 4px rgba(251,113,133,.10);}

.modal{
  position: fixed;
  inset: 0;
  background: rgba(0,0,0,.65);
  backdrop-filter: blur(10px);
  display:none;
  align-items:center;
  justify-content:center;
  padding: 18px;
  z-index: 11000;
}
.modal.open{display:flex}
.modal-card{
  width: min(980px, 100%);
  max-height: calc(100vh - 36px);
  overflow:auto;
  border-radius: 22px;
  border: 1px solid var(--border);
  background: linear-gradient(180deg, var(--card2), var(--card));
  box-shadow: var(--shadow);
  padding: 16px;
}
.modal-head{display:flex; align-items:flex-start; justify-content:space-between; gap: 12px; flex-wrap:wrap;}
.modal-head h3{margin:0; font-size: 15px;}
.modal-actions{display:flex; gap: 10px; flex-wrap:wrap;}
.report-box{
  border: 1px solid var(--border);
  border-radius: 16px;
  padding: 12px;
  background: rgba(0,0,0,.06);
}
:root[data-theme="light"] .report-box{background: rgba(16,24,40,.03)}
.kv{display:flex; justify-content:space-between; gap: 12px; flex-wrap:wrap; margin: 6px 0;}
.kv .k{color: var(--muted); font-weight: 950}
.kv .v{font-weight: 1000}
  </style>

  <!-- Chart.js (modern charts) -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>

  <!-- jsPDF + AutoTable (PDF save alohida) -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.31/jspdf.plugin.autotable.min.js"></script>
</head>

<body>

  <!-- LOGIN OVERLAY -->
  <div id="overlay" class="overlay">
    <div class="login-card">
      <div class="login-head">
        <div class="lgo" aria-hidden="true">‚Ç∏</div>
        <div>
          <h2 class="login-title">Kirish</h2>
          <p class="login-sub">Ism va kod bilan kiring. Har bir login uchun ma‚Äôlumotlar alohida saqlanadi (Firestore).</p>
        </div>
      </div>

      <div class="form">
        <div class="field">
          <label for="loginName">Ism (login)</label>
          <input id="loginName" placeholder="Masalan: Shahboz" autocomplete="username" />
          <small class="hint">Ism ‚Äî username. Masalan ‚Äúshahboz‚Äù va ‚ÄúShahboz‚Äù bir xil hisoblanadi.</small>
        </div>

        <div class="field">
          <label for="loginCode">Kod (parol)</label>
          <input id="loginCode" placeholder="Kamida 6 ta belgi" minlength="6" type="password" autocomplete="current-password" />
          <small class="hint">Parol kamida 6 ta belgi bo‚Äòlsin.</small>
        </div>

        <div class="login-actions">
          <button id="btnLogin" class="btn btn-primary" type="button">
            <span class="icon" aria-hidden="true">üîê</span>
            <span>Kirish</span>
          </button>
          <button id="btnSignup" class="btn btn-secondary" type="button">
            <span class="icon" aria-hidden="true">üÜï</span>
            <span>Ro‚Äòyxatdan o‚Äòtish</span>
          </button>
        </div>

        <div class="login-note">
          Bu login <b>Firebase Auth (Email/Password)</b> orqali ishlaydi: email avtomatik generatsiya qilinadi.<br/>
          Ishlashi uchun sayt <b>HTTPS</b>da bo‚Äòlishi kerak: <span class="inline-badge">GitHub Pages</span> yoki <span class="inline-badge">Firebase Hosting</span>.
        </div>
      </div>
    </div>
  </div>

  <div class="app" id="app" style="display:none">
    <header class="topbar">
      <div class="brand">
        <div class="logo" aria-hidden="true">‚Ç∏</div>
        <div>
          <h1>Kirim‚ÄìChiqim Hisobi</h1>
          <p class="muted">Faqat Firestore ‚Ä¢ Login: ism + kod ‚Ä¢ Real-time ‚Ä¢ Report/Print/PDF ‚Ä¢ Modern Charts</p>
        </div>
      </div>

      <div class="topbar-actions statbar">
        <span class="inline-badge">
          <span id="cloudDot" class="dotlive"></span>
          <span id="cloudText">Cloud: ulanmoqda‚Ä¶</span>
        </span>
        <span class="inline-badge" id="whoami">üë§ ‚Äî</span>
        <button id="btnTheme" class="btn btn-ghost" type="button" title="Tema (Light/Dark)">
          <span class="icon" aria-hidden="true">‚òæ</span>
          <span>Tema</span>
        </button>
        <button id="btnLogout" class="btn btn-secondary" type="button" title="Chiqish">
          <span class="icon" aria-hidden="true">‚éã</span>
          <span>Chiqish</span>
        </button>
      </div>
    </header>

    <main class="grid">
      <section class="card summary">
        <div class="summary-grid">
          <div class="metric metric-income">
            <div class="metric-label">Jami kirim (tanlangan hisoblash bo‚Äòyicha)</div>
            <div class="metric-value" id="sumIncome">0 so'm</div>
          </div>
          <div class="metric metric-expense">
            <div class="metric-label">Jami chiqim (tanlangan hisoblash bo‚Äòyicha)</div>
            <div class="metric-value" id="sumExpense">0 so'm</div>
          </div>
          <div class="metric metric-balance">
            <div class="metric-label">Balans</div>
            <div class="metric-value" id="sumBalance">0 so'm</div>
          </div>
        </div>

        <div class="summary-actions">
          <button id="btnToggleAnalysis" class="btn btn-secondary" type="button">
            <span class="icon" aria-hidden="true">üìä</span>
            <span>Tahlilni ko‚Äòrish</span>
          </button>

          <button id="btnOpenReport" class="btn btn-secondary" type="button">
            <span class="icon" aria-hidden="true">üßæ</span>
            <span>Hisobot / Chop / PDF</span>
          </button>

          <button id="btnClearAll" class="btn btn-danger" type="button">
            <span class="icon" aria-hidden="true">üóë</span>
            <span>Hammasini o‚Äòchirish</span>
          </button>
        </div>

        <div class="pillrow">
          <span class="pill">Firestore Only</span>
          <span class="pill">Email/Password Auth</span>
          <span class="pill">Sana diapazoni</span>
          <span class="pill">Chop / PDF alohida</span>
          <span class="pill">Grafiklar</span>
        </div>
      </section>

      <!-- Left: Entry -->
      <section class="card form-card">
        <h2 class="card-title">Yangi yozuv</h2>

        <form id="entryForm" class="form">
          <div class="segmented" role="group" aria-label="Kirim yoki chiqim tanlang">
            <label class="seg-item">
              <input type="radio" name="type" value="income" checked />
              <span>Kirim</span>
            </label>
            <label class="seg-item">
              <input type="radio" name="type" value="expense" />
              <span>Chiqim</span>
            </label>
          </div>

          <div class="two-col">
            <div class="field">
              <label for="amount">Summasi</label>
              <input id="amount" name="amount" inputmode="decimal" placeholder="Masalan: 150000" required />
              <small class="hint">Raqam kiriting (so‚Äòm). Bo‚Äòshliq/vergul bo‚Äòlsa ham bo‚Äòladi.</small>
            </div>

            <div class="field">
              <label for="date">Sana</label>
              <input id="date" name="date" type="date" required />
              <small class="hint">Default: bugungi sana.</small>
            </div>
          </div>

          <div class="two-col">
            <div class="field">
              <label for="category">Kategoriya</label>
              <input id="category" list="catList" placeholder="Masalan: Oziq-ovqat" />
              <datalist id="catList">
                <option value="Maosh"></option>
                <option value="Savdo"></option>
                <option value="Bonus"></option>
                <option value="Qarz qaytdi"></option>
                <option value="Oziq-ovqat"></option>
                <option value="Transport"></option>
                <option value="Ijara"></option>
                <option value="Kommunal"></option>
                <option value="Aloqa/Internet"></option>
                <option value="Sog'liq"></option>
                <option value="Ta'lim"></option>
                <option value="Kiyim-kechak"></option>
                <option value="Ko'ngilochar"></option>
                <option value="Kredit/Qarz"></option>
                <option value="Biznes"></option>
                <option value="Sovg'a"></option>
                <option value="Boshqa"></option>
              </datalist>
              <small class="hint">Ixtiyoriy. Kiritmasangiz ‚ÄúBoshqa‚Äù.</small>
            </div>

            <div class="field">
              <label for="note">Izoh (qayerdan / nimaga)</label>
              <input id="note" name="note" maxlength="160" placeholder="Masalan: Oylik / Market / Benzin..." required />
              <small class="hint">Majburiy.</small>
            </div>
          </div>

          <div class="form-actions">
            <button id="btnSave" class="btn btn-primary" type="submit">
              <span class="icon" aria-hidden="true">üíæ</span>
              <span>Saqlash</span>
            </button>
            <button id="btnCancelEdit" class="btn btn-ghost" type="button" hidden>
              <span class="icon" aria-hidden="true">‚Ü©</span>
              <span>Bekor</span>
            </button>
          </div>
        </form>
      </section>

      <!-- Right: List -->
      <section class="card list-card">
        <div class="list-head">
          <div>
            <h2 class="card-title" style="margin-bottom:6px">Yozuvlar</h2>
            <div class="muted" id="listHint" style="font-size:12px;font-weight:900">Real-time: oxirgi 200 ta. Ko‚Äòproq bo‚Äòlsa ‚ÄúYana yuklash‚Äù bosing.</div>
          </div>
          <div class="list-tools">
            <select id="filterType" class="select">
              <option value="all">Hammasi</option>
              <option value="income">Kirim</option>
              <option value="expense">Chiqim</option>
            </select>
            <input id="filterCategory" class="search" placeholder="Kategoriya (filter)..." />
            <input id="searchNote" class="search" placeholder="Izoh bo‚Äòyicha qidirish..." />
            <button id="btnReload" class="btn btn-mini" type="button" title="Yangilash">‚Üª Yangilash</button>
          </div>
        </div>

        <div class="table-wrap">
          <table class="table">
            <thead>
              <tr>
                <th>Sana</th>
                <th>Turi</th>
                <th>Kategoriya</th>
                <th>Izoh</th>
                <th>Summa</th>
                <th class="th-actions" style="text-align:right">Amallar</th>
              </tr>
            </thead>
            <tbody id="tbody"></tbody>
          </table>
        </div>

        <div id="cards" class="cards"></div>

        <div id="emptyBox" class="empty" style="display:none">
          <div class="empty-illu">üì≠</div>
          <div>
            <div class="empty-title">Hali yozuv yo‚Äòq</div>
            <div class="muted" style="font-size:12px;margin-top:2px">Chapdan kirim/chiqim qo‚Äòshing.</div>
          </div>
        </div>

        <div class="small-actions">
          <button id="btnLoadMore" class="btn btn-secondary" type="button">
            <span class="icon" aria-hidden="true">‚ûï</span>
            <span>Yana yuklash</span>
          </button>

          <button id="btnExportCsv" class="btn btn-secondary" type="button">
            <span class="icon" aria-hidden="true">‚¨á</span>
            <span>CSV export</span>
          </button>

          <label class="btn btn-secondary" for="csvFile" style="cursor:pointer">
            <span class="icon" aria-hidden="true">‚¨Ü</span>
            <span>CSV import</span>
          </label>
          <input id="csvFile" type="file" accept=".csv,text/csv" style="display:none" />
        </div>

        <div class="muted" style="font-size:12px;margin-top:10px">
          Eslatma: bu sahifa Firestore‚Äôga ulanib ishlaydi. <b>file://</b> bilan ochmang. GitHub Pages/Firebase Hosting kerak.
        </div>
      </section>

      <!-- Analytics (collapsible) -->
      <section class="card analysis" id="analysisCard">
        <div class="analysis-head">
          <div>
            <h2 class="card-title" style="margin-bottom:6px">Tahlil (tanlangan sana oralig‚Äòi bo‚Äòyicha)</h2>
            <div class="muted" style="font-size:12px;font-weight:900" id="analysisRangeText">‚Äî</div>
          </div>
          <div class="small-actions">
            <button id="btnRefreshAnalysis" class="btn btn-mini" type="button">‚Üª Yangilash</button>
          </div>
        </div>

        <div class="analysis-grid">
          <div class="canvas-wrap">
            <div class="canvas-title">
              <span>Kunlik kirim/chiqim (Line)</span>
              <span class="muted" id="lineMeta"></span>
            </div>
            <canvas id="lineChart"></canvas>
          </div>

          <div class="canvas-wrap">
            <div class="canvas-title">
              <span>Kategoriyalar bo‚Äòyicha chiqim (Doughnut)</span>
              <span class="muted" id="donutMeta"></span>
            </div>
            <canvas id="donutChart"></canvas>
          </div>
        </div>

        <div class="insights" id="insights"></div>
      </section>

      <!-- Reporting settings -->
      <section class="card reporting">
        <h2 class="card-title">Hisobot sozlamalari (sana tanlab)</h2>

        <div class="two-col">
          <div class="field">
            <label for="reportFrom">Hisobot: qaysi sanadan</label>
            <input id="reportFrom" type="date" />
          </div>
          <div class="field">
            <label for="reportTo">Hisobot: qaysi sanagacha</label>
            <input id="reportTo" type="date" />
          </div>
        </div>

        <div class="small-actions">
          <button id="btnRangeAll" class="btn btn-secondary" type="button">
            <span class="icon" aria-hidden="true">‚àû</span>
            <span>Barchasi</span>
          </button>
          <button id="btnRangeThisMonth" class="btn btn-secondary" type="button" title="Siz tanlagan 'Oy boshi kuni' bo‚Äòyicha">
            <span class="icon" aria-hidden="true">üóì</span>
            <span>Hozirgi oy</span>
          </button>
          <div class="field" style="flex:1;min-width:220px;margin:0">
            <label for="reportType">Hisobot turi</label>
            <select id="reportType">
              <option value="all">Kirim + Chiqim</option>
              <option value="income">Faqat kirim</option>
              <option value="expense">Faqat chiqim</option>
            </select>
          </div>
        </div>

        <div class="hr"></div>

        <label class="switch">
          <input id="useReportForCalc" type="checkbox" checked />
          <div>
            <div style="font-weight:950">Hisoblash ham shu diapazon bo‚Äòyicha</div>
            <div class="muted" style="font-size:12px">O‚Äòchirsangiz ‚Äî kirim va chiqimni alohida sanalar bilan hisoblay olasiz.</div>
          </div>
        </label>

        <div id="calcRangesBox" hidden>
          <div class="two-col" style="margin-top:12px">
            <div class="field">
              <label for="calcIncomeFrom">Kirim hisoblash: from</label>
              <input id="calcIncomeFrom" type="date" />
            </div>
            <div class="field">
              <label for="calcIncomeTo">Kirim hisoblash: to</label>
              <input id="calcIncomeTo" type="date" />
            </div>
          </div>

          <div class="two-col" style="margin-top:12px">
            <div class="field">
              <label for="calcExpenseFrom">Chiqim hisoblash: from</label>
              <input id="calcExpenseFrom" type="date" />
            </div>
            <div class="field">
              <label for="calcExpenseTo">Chiqim hisoblash: to</label>
              <input id="calcExpenseTo" type="date" />
            </div>
          </div>
        </div>

        <div class="two-col" style="margin-top:12px">
          <div class="field">
            <label for="fiscalStartDay">Oy boshi kuni</label>
            <select id="fiscalStartDay"></select>
            <small class="hint">Masalan: 25-kun ‚Äî oy 25dan boshlanadi, keyingi oyning 24iga qadar.</small>
          </div>

          <div class="field">
            <label>Hisobot tarkibi</label>
            <label class="switch" style="margin-top:6px">
              <input id="includeCharts" type="checkbox" checked />
              <div><div style="font-weight:950">Grafiklarni qo‚Äòshish</div></div>
            </label>
            <label class="switch" style="margin-top:8px">
              <input id="includeDetails" type="checkbox" checked />
              <div><div style="font-weight:950">Detallarni qo‚Äòshish</div></div>
            </label>
          </div>
        </div>

        <div class="field" style="margin-top:10px">
          <label for="maxDetailRows">Detallar limiti (0‚Äì5000)</label>
          <input id="maxDetailRows" type="number" min="0" max="5000" step="50" value="300" />
          <small class="hint">Detallar ko‚Äòp bo‚Äòlsa PDF og‚Äòirlashadi. 0 qo‚Äòysangiz detal chiqmaydi.</small>
        </div>

        <div class="small-actions" style="margin-top: 12px">
          <button id="btnApplyRange" class="btn btn-primary" type="button">
            <span class="icon" aria-hidden="true">‚úÖ</span>
            <span>Diapazonni qo‚Äòllash</span>
          </button>
          <button id="btnQuickReport" class="btn btn-secondary" type="button">
            <span class="icon" aria-hidden="true">üëÅ</span>
            <span>Hisobotni ko‚Äòrish</span>
          </button>
        </div>
      </section>

      <div class="footer muted">
        ¬© Kirim‚ÄìChiqim ‚Ä¢ Firestore Only ‚Ä¢ Telefon va kompyuterga mos
      </div>
    </main>
  </div>

  <!-- REPORT MODAL -->
  <div id="reportModal" class="modal" role="dialog" aria-modal="true" aria-label="Hisobot">
    <div class="modal-card">
      <div class="modal-head">
        <div>
          <h3>Hisobot</h3>
          <div class="muted" style="font-size:12px;font-weight:900" id="reportTitle">‚Äî</div>
        </div>
        <div class="modal-actions">
          <button id="btnPrint" class="btn btn-secondary" type="button">
            <span class="icon" aria-hidden="true">üñ®</span>
            <span>Chop etish</span>
          </button>
          <button id="btnPdf" class="btn btn-secondary" type="button">
            <span class="icon" aria-hidden="true">üìÑ</span>
            <span>PDF saqlash</span>
          </button>
          <button id="btnCloseReport" class="btn btn-ghost" type="button">
            <span class="icon" aria-hidden="true">‚úï</span>
            <span>Yopish</span>
          </button>
        </div>
      </div>

      <div class="hr"></div>

      <div id="reportSummary" class="report-box"></div>

      <div id="reportCharts" style="margin-top:12px; display:none">
        <div class="analysis-grid">
          <div class="canvas-wrap">
            <div class="canvas-title"><span>Kunlik kirim/chiqim</span><span class="muted" id="rLineMeta"></span></div>
            <canvas id="rLineChart"></canvas>
          </div>
          <div class="canvas-wrap">
            <div class="canvas-title"><span>Kategoriya chiqim</span><span class="muted" id="rDonutMeta"></span></div>
            <canvas id="rDonutChart"></canvas>
          </div>
        </div>
      </div>

      <div id="reportDetails" style="margin-top:12px"></div>
    </div>
  </div>

  <div id="toast" class="toast" style="display:none"></div>

  <script type="module">
    // Firebase (CDN modules)
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-app.js";
    import {
      getFirestore, collection, addDoc, deleteDoc, doc, updateDoc, query, where, orderBy, limit, startAfter,
      getDocs, onSnapshot, serverTimestamp, setDoc, getDoc, writeBatch
    } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-firestore.js";
    import {
      getAuth, setPersistence, browserLocalPersistence,
      signInWithEmailAndPassword, createUserWithEmailAndPassword, onAuthStateChanged, signOut, updateProfile
    } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-auth.js";

    // ====== YOUR FIREBASE CONFIG (SIZ BERGAN) ======
    const firebaseConfig = {
      apiKey: "AIzaSyDLIJg7UfsVYiz9HdhbwblqQ_3ZYZPJ8fg",
      authDomain: "shahbozbek-4922b.firebaseapp.com",
      projectId: "shahbozbek-4922b",
      storageBucket: "shahbozbek-4922b.firebasestorage.app",
      messagingSenderId: "131010057146",
      appId: "1:131010057146:web:f9fe30976d19e9d1ea0383",
      measurementId: "G-3XCQLHNYC2"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    const auth = getAuth(app);

    // Persist session (telefon/kompyuterda qayta kirish shart emas)
    await setPersistence(auth, browserLocalPersistence);

    // ====== UI refs ======
    const $ = (id) => document.getElementById(id);

    const overlay = $("overlay");
    const appEl = $("app");

    const loginName = $("loginName");
    const loginCode = $("loginCode");
    const btnLogin = $("btnLogin");
    const btnSignup = $("btnSignup");

    const cloudDot = $("cloudDot");
    const cloudText = $("cloudText");
    const whoami = $("whoami");

    const btnTheme = $("btnTheme");
    const btnLogout = $("btnLogout");

    const entryForm = $("entryForm");
    const amountEl = $("amount");
    const dateEl = $("date");
    const categoryEl = $("category");
    const noteEl = $("note");
    const btnCancelEdit = $("btnCancelEdit");

    const tbody = $("tbody");
    const cards = $("cards");
    const emptyBox = $("emptyBox");

    const filterType = $("filterType");
    const filterCategory = $("filterCategory");
    const searchNote = $("searchNote");
    const btnReload = $("btnReload");
    const btnLoadMore = $("btnLoadMore");
    const btnClearAll = $("btnClearAll");

    const sumIncome = $("sumIncome");
    const sumExpense = $("sumExpense");
    const sumBalance = $("sumBalance");

    const btnToggleAnalysis = $("btnToggleAnalysis");
    const analysisCard = $("analysisCard");
    const analysisRangeText = $("analysisRangeText");
    const btnRefreshAnalysis = $("btnRefreshAnalysis");
    const insightsBox = $("insights");

    const reportFrom = $("reportFrom");
    const reportTo = $("reportTo");
    const reportType = $("reportType");
    const btnRangeAll = $("btnRangeAll");
    const btnRangeThisMonth = $("btnRangeThisMonth");
    const useReportForCalc = $("useReportForCalc");
    const calcRangesBox = $("calcRangesBox");
    const calcIncomeFrom = $("calcIncomeFrom");
    const calcIncomeTo = $("calcIncomeTo");
    const calcExpenseFrom = $("calcExpenseFrom");
    const calcExpenseTo = $("calcExpenseTo");
    const fiscalStartDay = $("fiscalStartDay");
    const includeCharts = $("includeCharts");
    const includeDetails = $("includeDetails");
    const maxDetailRows = $("maxDetailRows");
    const btnApplyRange = $("btnApplyRange");
    const btnQuickReport = $("btnQuickReport");
    const btnOpenReport = $("btnOpenReport");

    const btnExportCsv = $("btnExportCsv");
    const csvFile = $("csvFile");

    const toastEl = $("toast");

    const reportModal = $("reportModal");
    const reportTitle = $("reportTitle");
    const reportSummary = $("reportSummary");
    const reportDetails = $("reportDetails");
    const reportChartsWrap = $("reportCharts");
    const btnCloseReport = $("btnCloseReport");
    const btnPrint = $("btnPrint");
    const btnPdf = $("btnPdf");

    // analytics canvases
    const lineCanvas = $("lineChart");
    const donutCanvas = $("donutChart");
    const lineMeta = $("lineMeta");
    const donutMeta = $("donutMeta");

    const rLineCanvas = $("rLineChart");
    const rDonutCanvas = $("rDonutChart");
    const rLineMeta = $("rLineMeta");
    const rDonutMeta = $("rDonutMeta");

    // ====== State ======
    let currentUser = null;
    let unsubList = null;
    let listDocs = []; // last loaded docs (200 + pages)
    let lastDoc = null;
    let editingId = null;

    // Chart instances
    let lineChart = null;
    let donutChart = null;
    let rLineChart = null;
    let rDonutChart = null;

    // ====== Helpers ======
    const nf = new Intl.NumberFormat("uz-UZ");
    const fmt = (n) => `${nf.format(Math.round(n || 0))} so'm`;

    function todayStr(){
      const d = new Date();
      const m = String(d.getMonth()+1).padStart(2,"0");
      const day = String(d.getDate()).padStart(2,"0");
      return `${d.getFullYear()}-${m}-${day}`;
    }

    function toast(msg, ms=2400){
      toastEl.textContent = msg;
      toastEl.style.display = "block";
      clearTimeout(toastEl._t);
      toastEl._t = setTimeout(()=> toastEl.style.display = "none", ms);
    }

    function setCloudState(state, text){
      // state: "ok" | "bad" | "wait"
      cloudDot.classList.remove("ok","bad");
      if(state==="ok") cloudDot.classList.add("ok");
      if(state==="bad") cloudDot.classList.add("bad");
      cloudText.textContent = text;
    }

    function normalizeName(name){
      const raw = (name || "").trim().toLowerCase();
      const simple = raw.normalize("NFKD").replace(/[\u0300-\u036f]/g, "");
      const cleaned = simple.replace(/\s+/g, ".").replace(/[^a-z0-9._-]/g, "");
      return cleaned.slice(0, 40);
    }

    function emailFromName(name){
      const u = normalizeName(name);
      if(!u) return null;
      return `${u}@kirimchiqim.local`;
    }

    function parseAmount(v){
      const s = String(v || "").replace(/[^\d.,-]/g, "").replace(/,/g, ".");
      const n = Number(s);
      if(!Number.isFinite(n)) return NaN;
      return Math.round(n);
    }

    function inRange(dateStr, fromStr, toStr){
      if(!dateStr) return false;
      if(fromStr && dateStr < fromStr) return false;
      if(toStr && dateStr > toStr) return false;
      return true;
    }

    function getFiscalMonthRange(baseDateStr, startDay){
      // returns {from,to} for "current fiscal month" containing baseDate
      const base = baseDateStr ? new Date(baseDateStr + "T00:00:00") : new Date();
      const sd = Math.min(28, Math.max(1, Number(startDay || 1)));

      let y = base.getFullYear();
      let m = base.getMonth(); // 0-11

      // determine start date of current fiscal month
      let start = new Date(y, m, sd);
      if(base.getDate() < sd){
        // fiscal month started previous month
        m -= 1;
        if(m < 0){ m = 11; y -= 1; }
        start = new Date(y, m, sd);
      }

      // end = day before next fiscal start
      let ny = y, nm = m + 1;
      if(nm > 11){ nm = 0; ny += 1; }
      const nextStart = new Date(ny, nm, sd);
      const end = new Date(nextStart.getTime() - 24*60*60*1000);

      const toStr = (d)=> `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,"0")}-${String(d.getDate()).padStart(2,"0")}`;
      return { from: toStr(start), to: toStr(end) };
    }

    function esc(s){
      return String(s ?? "").replace(/[&<>"']/g, c => ({ "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;" }[c]));
    }

    // ====== Theme in Firestore (NO localStorage) ======
    async function loadProfileTheme(uid){
      try{
        const ref = doc(db, "users", uid, "profile", "settings");
        const snap = await getDoc(ref);
        const theme = snap.exists() ? snap.data().theme : null;
        if(theme === "light") document.documentElement.dataset.theme = "light";
        else document.documentElement.dataset.theme = "dark";
      }catch(e){
        // default
        document.documentElement.dataset.theme = "dark";
      }
    }

    async function saveProfileTheme(uid, theme){
      const ref = doc(db, "users", uid, "profile", "settings");
      await setDoc(ref, { theme }, { merge: true });
    }

    // ====== Firestore paths ======
    const txCol = () => collection(db, "users", currentUser.uid, "transactions");

    // ====== List realtime (paged) ======
    function buildBaseListQuery(){
      const from = reportFrom.value || "";
      const to = reportTo.value || "";
      // Keep it index-friendly: range+orderby on same field only.
      if(from && to){
        return query(txCol(), where("date", ">=", from), where("date", "<=", to), orderBy("date", "desc"), limit(200));
      } else if(from){
        return query(txCol(), where("date", ">=", from), orderBy("date", "desc"), limit(200));
      } else if(to){
        return query(txCol(), where("date", "<=", to), orderBy("date", "desc"), limit(200));
      } else {
        return query(txCol(), orderBy("date", "desc"), limit(200));
      }
    }

    function attachRealtimeList(){
      if(unsubList) { unsubList(); unsubList = null; }
      listDocs = [];
      lastDoc = null;
      renderList([]);
      setCloudState("wait", "Cloud: ulanmoqda‚Ä¶");

      const q = buildBaseListQuery();
      unsubList = onSnapshot(q, (snap)=>{
        setCloudState("ok", "Cloud: ulandi");
        listDocs = snap.docs.map(d => ({ id: d.id, ...d.data() }));
        lastDoc = snap.docs.length ? snap.docs[snap.docs.length-1] : null;
        renderList(listDocs);
        // refresh summary+analysis in background (range-based)
        refreshSummaryAndAnalysis(false);
      }, (err)=>{
        console.error(err);
        setCloudState("bad", "Cloud: xato");
        toast("Cloud ulanmayapti. Hosting/Rules/Auth tekshiring.");
      });
    }

    async function loadMore(){
      if(!lastDoc) { toast("Yana ma'lumot yo‚Äòq."); return; }

      btnLoadMore.disabled = true;
      try{
        const from = reportFrom.value || "";
        const to = reportTo.value || "";

        let q;
        if(from && to){
          q = query(txCol(), where("date", ">=", from), where("date", "<=", to), orderBy("date", "desc"), startAfter(lastDoc), limit(200));
        } else if(from){
          q = query(txCol(), where("date", ">=", from), orderBy("date", "desc"), startAfter(lastDoc), limit(200));
        } else if(to){
          q = query(txCol(), where("date", "<=", to), orderBy("date", "desc"), startAfter(lastDoc), limit(200));
        } else {
          q = query(txCol(), orderBy("date", "desc"), startAfter(lastDoc), limit(200));
        }

        const snap = await getDocs(q);
        const more = snap.docs.map(d => ({ id: d.id, ...d.data() }));
        if(snap.docs.length) lastDoc = snap.docs[snap.docs.length-1];
        else lastDoc = null;

        listDocs = listDocs.concat(more);
        renderList(listDocs);
        toast(more.length ? `Yana ${more.length} ta yuklandi.` : "Yana ma'lumot yo‚Äòq.");
      }catch(e){
        console.error(e);
        toast("Yuklashda xato. Internet/Rules tekshiring.");
      }finally{
        btnLoadMore.disabled = false;
      }
    }

    function applyClientFilters(rows){
      const t = filterType.value;
      const cat = (filterCategory.value || "").trim().toLowerCase();
      const q = (searchNote.value || "").trim().toLowerCase();

      return rows.filter(r=>{
        if(t !== "all" && r.type !== t) return false;
        if(cat && String(r.category||"").toLowerCase().indexOf(cat) === -1) return false;
        if(q && String(r.note||"").toLowerCase().indexOf(q) === -1) return false;
        return true;
      });
    }

    function renderList(rows){
      const filtered = applyClientFilters(rows);

      tbody.innerHTML = "";
      cards.innerHTML = "";

      if(!filtered.length){
        emptyBox.style.display = "flex";
      } else {
        emptyBox.style.display = "none";
      }

      // Desktop table
      for(const r of filtered){
        const tr = document.createElement("tr");

        const typeBadge = r.type === "income"
          ? `<span class="badge income">‚¨Ü Kirim</span>`
          : `<span class="badge expense">‚¨á Chiqim</span>`;

        const catBadge = `<span class="badge cat">${esc(r.category || "Boshqa")}</span>`;
        const amountClass = r.type === "income" ? "income" : "expense";

        tr.innerHTML = `
          <td>${esc(r.date || "")}</td>
          <td>${typeBadge}</td>
          <td>${catBadge}</td>
          <td>${esc(r.note || "")}</td>
          <td><span class="amount ${amountClass}">${fmt(r.amount || 0)}</span></td>
          <td class="td-actions">
            <div class="row-actions">
              <button class="btn btn-mini" data-edit="${r.id}">‚úé Tahrir</button>
              <button class="btn btn-mini del" data-del="${r.id}">üóë O'chir</button>
            </div>
          </td>
        `;
        tbody.appendChild(tr);
      }

      // Mobile cards
      for(const r of filtered){
        const item = document.createElement("div");
        item.className = "card-item";
        const amountClass = r.type === "income" ? "income" : "expense";
        const typeBadge = r.type === "income"
          ? `<span class="badge income">‚¨Ü Kirim</span>`
          : `<span class="badge expense">‚¨á Chiqim</span>`;

        item.innerHTML = `
          <div class="card-top">
            <div class="card-meta">
              ${typeBadge}
              <span class="badge cat">${esc(r.category || "Boshqa")}</span>
            </div>
            <div class="card-date">${esc(r.date || "")}</div>
          </div>
          <div class="card-note">${esc(r.note || "")}</div>
          <div style="margin-top:8px; display:flex; align-items:center; justify-content:space-between; gap:10px; flex-wrap:wrap;">
            <div class="card-amount amount ${amountClass}">${fmt(r.amount || 0)}</div>
            <div class="card-actions">
              <button class="btn btn-mini" data-edit="${r.id}">‚úé Tahrir</button>
              <button class="btn btn-mini del" data-del="${r.id}">üóë O'chir</button>
            </div>
          </div>
        `;
        cards.appendChild(item);
      }
    }

    // ====== Summary + Analysis (range fetch, no localStorage) ======
    async function fetchRangeDocs(){
      // fetch docs in selected "calculation" ranges.
      // To keep index easy, we query by date only; filter type in JS.
      // If ranges are empty: fetch up to 5000 newest docs (for summary/analysis).
      const LIMIT = 5000;

      const useReport = useReportForCalc.checked;
      const rFrom = reportFrom.value || "";
      const rTo = reportTo.value || "";

      const iFrom = useReport ? rFrom : (calcIncomeFrom.value || "");
      const iTo   = useReport ? rTo   : (calcIncomeTo.value || "");
      const eFrom = useReport ? rFrom : (calcExpenseFrom.value || "");
      const eTo   = useReport ? rTo   : (calcExpenseTo.value || "");

      const makeQ = (from,to)=> {
        if(from && to) return query(txCol(), where("date", ">=", from), where("date","<=",to), orderBy("date","asc"), limit(LIMIT));
        if(from) return query(txCol(), where("date", ">=", from), orderBy("date","asc"), limit(LIMIT));
        if(to) return query(txCol(), where("date", "<=", to), orderBy("date","asc"), limit(LIMIT));
        return query(txCol(), orderBy("date","desc"), limit(LIMIT)); // fallback
      };

      const [incSnap, expSnap] = await Promise.all([
        getDocs(makeQ(iFrom,iTo)),
        getDocs(makeQ(eFrom,eTo)),
      ]);

      const inc = incSnap.docs.map(d=>({id:d.id, ...d.data()})).filter(x=>x.type==="income");
      const exp = expSnap.docs.map(d=>({id:d.id, ...d.data()})).filter(x=>x.type==="expense");

      return { inc, exp, meta: { LIMIT, useReport, rFrom, rTo, iFrom, iTo, eFrom, eTo } };
    }

    function buildDailySeries(all, fromStr, toStr){
      // all = transactions in range (both types)
      const map = new Map(); // date -> {income,expense}
      for(const r of all){
        if(!r.date) continue;
        if(!inRange(r.date, fromStr, toStr)) continue;
        const cur = map.get(r.date) || { income:0, expense:0 };
        if(r.type==="income") cur.income += (r.amount||0);
        else if(r.type==="expense") cur.expense += (r.amount||0);
        map.set(r.date, cur);
      }
      const dates = Array.from(map.keys()).sort();
      const incomes = dates.map(d=>map.get(d).income);
      const expenses = dates.map(d=>map.get(d).expense);
      return { dates, incomes, expenses };
    }

    function buildCategoryTotals(rows, type){
      const m = new Map();
      for(const r of rows){
        if(r.type!==type) continue;
        const c = (r.category || "Boshqa").trim() || "Boshqa";
        m.set(c, (m.get(c)||0) + (r.amount||0));
      }
      const entries = Array.from(m.entries()).sort((a,b)=>b[1]-a[1]);
      return entries;
    }

    function makeInsights(all, fromStr, toStr){
      // peak day income / expense + quietest day by total
      const daily = new Map();
      for(const r of all){
        if(!r.date) continue;
        if(!inRange(r.date, fromStr, toStr)) continue;
        daily.set(r.date, (daily.get(r.date)||0) + (r.amount||0));
      }
      const days = Array.from(daily.entries());
      let max = null, min = null;
      for(const [d,v] of days){
        if(!max || v > max[1]) max = [d,v];
        if(!min || v < min[1]) min = [d,v];
      }

      const incomeTotal = all.filter(x=>x.type==="income" && inRange(x.date, fromStr, toStr)).reduce((s,x)=>s+(x.amount||0),0);
      const expenseTotal = all.filter(x=>x.type==="expense" && inRange(x.date, fromStr, toStr)).reduce((s,x)=>s+(x.amount||0),0);

      // Most frequent category expense
      const catExp = buildCategoryTotals(all, "expense");
      const topCat = catExp.length ? `${catExp[0][0]} (${fmt(catExp[0][1])})` : "‚Äî";

      return [
        { k:"Eng ko‚Äòp harakat kuni", v: max ? `${max[0]} ‚Ä¢ ${fmt(max[1])}` : "‚Äî" },
        { k:"Eng kam harakat kuni", v: min ? `${min[0]} ‚Ä¢ ${fmt(min[1])}` : "‚Äî" },
        { k:"Eng katta chiqim kategoriyasi", v: topCat },
        { k:"Jami kirim", v: fmt(incomeTotal) },
        { k:"Jami chiqim", v: fmt(expenseTotal) },
        { k:"Balans", v: fmt(incomeTotal - expenseTotal) },
      ];
    }

    function renderInsights(items){
      insightsBox.innerHTML = "";
      const show = items.slice(0,6);
      for(const it of show){
        const div = document.createElement("div");
        div.className = "insight";
        div.innerHTML = `<div class="k">${esc(it.k)}</div><div class="v">${esc(it.v)}</div>`;
        insightsBox.appendChild(div);
      }
    }

    function ensureChartInstances(){
      if(!window.Chart) return;

      const baseLineCfg = (labels, incomeData, expenseData)=>({
        type: "line",
        data: {
          labels,
          datasets: [
            { label: "Kirim", data: incomeData, tension: 0.28, borderWidth: 2, fill: true },
            { label: "Chiqim", data: expenseData, tension: 0.28, borderWidth: 2, fill: true }
          ]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          interaction: { mode: "index", intersect: false },
          plugins: {
            legend: { display: true },
            tooltip: { callbacks: { label: (ctx)=> `${ctx.dataset.label}: ${fmt(ctx.raw)}` } }
          },
          scales: {
            y: { ticks: { callback: (v)=> nf.format(v) } }
          }
        }
      });

      const donutCfg = (labels, data)=>({
        type: "doughnut",
        data: { labels, datasets: [{ data, borderWidth: 0 }] },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            legend: { position: "bottom" },
            tooltip: { callbacks: { label: (ctx)=> `${ctx.label}: ${fmt(ctx.raw)}` } }
          }
        }
      });

      return { baseLineCfg, donutCfg };
    }

    function setChart(chartRef, canvas, cfg){
      if(chartRef) chartRef.destroy();
      return new Chart(canvas.getContext("2d"), cfg);
    }

    async function refreshSummaryAndAnalysis(forceToast=true){
      if(!currentUser) return;

      try{
        const { inc, exp, meta } = await fetchRangeDocs();
        const incSum = inc.reduce((s,x)=>s+(x.amount||0),0);
        const expSum = exp.reduce((s,x)=>s+(x.amount||0),0);

        sumIncome.textContent = fmt(incSum);
        sumExpense.textContent = fmt(expSum);
        sumBalance.textContent = fmt(incSum - expSum);

        // range label for analysis
        const fromShow = meta.useReport ? (meta.rFrom || "‚Ä¶") : `${meta.iFrom||"‚Ä¶"} / ${meta.eFrom||"‚Ä¶"}`;
        const toShow = meta.useReport ? (meta.rTo || "‚Ä¶") : `${meta.iTo||"‚Ä¶"} / ${meta.eTo||"‚Ä¶"}`;
        analysisRangeText.textContent = `Diapazon: ${fromShow} ‚Üí ${toShow}`;

        // if analysis open, refresh charts
        if(analysisCard.classList.contains("open")){
          const all = inc.concat(exp);
          const from = meta.useReport ? meta.rFrom : "";
          const to = meta.useReport ? meta.rTo : "";

          const cfgs = ensureChartInstances();
          if(cfgs){
            const { dates, incomes, expenses } = buildDailySeries(all, from, to);
            lineMeta.textContent = `${dates.length} kun`;
            donutMeta.textContent = "Chiqim";

            lineChart = setChart(lineChart, lineCanvas, cfgs.baseLineCfg(dates, incomes, expenses));

            const cat = buildCategoryTotals(all, "expense");
            const labels = cat.slice(0, 10).map(x=>x[0]);
            const data = cat.slice(0, 10).map(x=>x[1]);
            donutChart = setChart(donutChart, donutCanvas, cfgs.donutCfg(labels, data));

            renderInsights(makeInsights(all, from, to));
          }
        }

        if(forceToast){
          toast(`Hisob yangilandi. (limit: ${meta.LIMIT})`);
        }
      }catch(e){
        console.error(e);
        toast("Hisoblashda xato. Firestore/Rules/Internet tekshiring.");
      }
    }

    // ====== Report ======
    function getReportOptions(){
      const from = reportFrom.value || "";
      const to = reportTo.value || "";
      const type = reportType.value;
      const maxRows = Math.max(0, Math.min(5000, Number(maxDetailRows.value || 0)));
      return {
        from, to, type,
        includeCharts: includeCharts.checked,
        includeDetails: includeDetails.checked,
        maxRows
      };
    }

    async function buildReportData(){
      const opt = getReportOptions();
      const LIMIT = 5000; // for fetching (can be adjusted)

      // fetch by date only to avoid composite indexes
      const makeQ = ()=>{
        if(opt.from && opt.to) return query(txCol(), where("date", ">=", opt.from), where("date","<=",opt.to), orderBy("date","asc"), limit(LIMIT));
        if(opt.from) return query(txCol(), where("date", ">=", opt.from), orderBy("date","asc"), limit(LIMIT));
        if(opt.to) return query(txCol(), where("date", "<=", opt.to), orderBy("date","asc"), limit(LIMIT));
        return query(txCol(), orderBy("date","asc"), limit(LIMIT));
      };

      const snap = await getDocs(makeQ());
      let rows = snap.docs.map(d=>({id:d.id, ...d.data()}));

      if(opt.type !== "all"){
        rows = rows.filter(r=>r.type === opt.type);
      }

      // summary
      const income = rows.filter(r=>r.type==="income").reduce((s,x)=>s+(x.amount||0),0);
      const expense = rows.filter(r=>r.type==="expense").reduce((s,x)=>s+(x.amount||0),0);
      const balance = income - expense;

      // details (limit)
      const details = opt.includeDetails ? rows.slice(0, opt.maxRows) : [];

      return { opt, rows, details, summary: { income, expense, balance, count: rows.length, fetchLimit: LIMIT } };
    }

    function openReportModal(){
      reportModal.classList.add("open");
      document.body.style.overflow = "hidden";
    }
    function closeReportModal(){
      reportModal.classList.remove("open");
      document.body.style.overflow = "";
      // destroy report charts
      if(rLineChart){ rLineChart.destroy(); rLineChart=null; }
      if(rDonutChart){ rDonutChart.destroy(); rDonutChart=null; }
    }

    async function renderReport(){
      try{
        btnQuickReport.disabled = true;
        btnOpenReport.disabled = true;
        toast("Hisobot tayyorlanmoqda‚Ä¶", 1800);

        const data = await buildReportData();
        const { opt, rows, details, summary } = data;

        const title = `Diapazon: ${opt.from || "barchasi"} ‚Üí ${opt.to || "barchasi"} ‚Ä¢ ${opt.type==="all"?"Kirim+Chiqim":(opt.type==="income"?"Kirim":"Chiqim")}`;
        reportTitle.textContent = title;

        reportSummary.innerHTML = `
          <div class="kv"><div class="k">Jami yozuv</div><div class="v">${summary.count}</div></div>
          <div class="kv"><div class="k">Jami kirim</div><div class="v" style="color:var(--income)">${fmt(summary.income)}</div></div>
          <div class="kv"><div class="k">Jami chiqim</div><div class="v" style="color:var(--expense)">${fmt(summary.expense)}</div></div>
          <div class="kv"><div class="k">Balans</div><div class="v">${fmt(summary.balance)}</div></div>
          <div class="kv"><div class="k">Fetch limiti</div><div class="v">${summary.fetchLimit}</div></div>
        `;

        // charts
        reportChartsWrap.style.display = opt.includeCharts ? "block" : "none";
        if(opt.includeCharts){
          const cfgs = ensureChartInstances();
          const from = opt.from || "";
          const to = opt.to || "";

          const daily = buildDailySeries(rows, from, to);
          rLineMeta.textContent = `${daily.dates.length} kun`;
          rDonutMeta.textContent = "Chiqim";

          rLineChart = setChart(rLineChart, rLineCanvas, cfgs.baseLineCfg(daily.dates, daily.incomes, daily.expenses));

          const cat = buildCategoryTotals(rows, "expense");
          const labels = cat.slice(0, 12).map(x=>x[0]);
          const vals = cat.slice(0, 12).map(x=>x[1]);
          rDonutChart = setChart(rDonutChart, rDonutCanvas, cfgs.donutCfg(labels, vals));
        }

        // details
        reportDetails.innerHTML = "";
        if(opt.includeDetails && opt.maxRows > 0){
          const wrap = document.createElement("div");
          wrap.className = "table-wrap";
          wrap.style.marginTop = "12px";
          wrap.innerHTML = `
            <table class="table" style="min-width: 900px">
              <thead>
                <tr>
                  <th>Sana</th><th>Turi</th><th>Kategoriya</th><th>Izoh</th><th>Summa</th>
                </tr>
              </thead>
              <tbody>
                ${details.map(r=>{
                  const t = r.type==="income" ? "Kirim" : "Chiqim";
                  const cls = r.type==="income" ? "income" : "expense";
                  return `<tr>
                    <td>${esc(r.date||"")}</td>
                    <td>${esc(t)}</td>
                    <td>${esc(r.category||"Boshqa")}</td>
                    <td>${esc(r.note||"")}</td>
                    <td><span class="amount ${cls}">${fmt(r.amount||0)}</span></td>
                  </tr>`;
                }).join("")}
              </tbody>
            </table>
          `;
          reportDetails.appendChild(wrap);

          if(summary.count > details.length){
            const more = document.createElement("div");
            more.className = "muted";
            more.style.marginTop = "10px";
            more.style.fontSize = "12px";
            more.style.fontWeight = "900";
            more.textContent = `Detallar limit sabab ${details.length} ta ko‚Äòrsatildi (jami ${summary.count}).`;
            reportDetails.appendChild(more);
          }
        } else {
          const note = document.createElement("div");
          note.className = "muted";
          note.style.fontSize = "12px";
          note.style.fontWeight = "900";
          note.textContent = "Detallar o‚Äòchirilgan (yoki limit 0).";
          reportDetails.appendChild(note);
        }

        openReportModal();
      }catch(e){
        console.error(e);
        toast("Hisobotda xato. Diapazon toraytiring yoki internet tekshiring.");
      }finally{
        btnQuickReport.disabled = false;
        btnOpenReport.disabled = false;
      }
    }

    async function reportPrint(){
      // Print alohida: new window with clean HTML
      const title = reportTitle.textContent || "Hisobot";
      const summaryHtml = reportSummary.innerHTML;
      const detailsHtml = reportDetails.innerHTML;
      const showCharts = includeCharts.checked;

      const w = window.open("", "_blank");
      if(!w){ toast("Popup bloklangan. Brauzer ruxsat bering."); return; }

      const theme = document.documentElement.dataset.theme || "dark";
      const bg = theme === "light" ? "#ffffff" : "#0b0f19";
      const text = theme === "light" ? "#111827" : "#ffffff";
      const muted = theme === "light" ? "#6b7280" : "rgba(255,255,255,.72)";

      w.document.write(`<!doctype html>
<html><head><meta charset="utf-8"><meta name="viewport" content="width=device-width, initial-scale=1">
<title>${esc(title)}</title>
<style>
  body{font-family:Inter,Arial,sans-serif;background:${bg};color:${text};margin:0;padding:22px}
  h1{font-size:18px;margin:0}
  .muted{color:${muted};font-size:12px;font-weight:700;margin-top:6px}
  .box{border:1px solid rgba(0,0,0,.12);border-radius:14px;padding:12px;margin-top:12px}
  table{width:100%;border-collapse:collapse;margin-top:12px}
  th,td{border-bottom:1px solid rgba(0,0,0,.12);padding:10px;font-size:12px;vertical-align:top;text-align:left}
  th{background:rgba(0,0,0,.04)}
  .income{color:#14b8a6;font-weight:800}
  .expense{color:#fb7185;font-weight:800}
  @media print{ body{padding:0} }
</style></head>
<body>
  <h1>${esc(title)}</h1>
  <div class="muted">Chop etish uchun tayyor (Print). Agar PDF kerak bo‚Äòlsa ‚Äî alohida ‚ÄúPDF saqlash‚Äù tugmasini bosing.</div>
  <div class="box">${summaryHtml}</div>
  ${detailsHtml}
</body></html>`);
      w.document.close();
      w.focus();
      w.print();
    }

    async function reportPdf(){
      // PDF alohida: jsPDF + autotable
      try{
        const data = await buildReportData();
        const { opt, details, summary } = data;

        const { jsPDF } = window.jspdf;
        const docPdf = new jsPDF({ orientation: "p", unit: "pt", format: "a4" });

        const title = `Kirim‚ÄìChiqim Hisobot`;
        const subtitle = `${opt.from || "barchasi"} ‚Üí ${opt.to || "barchasi"} ‚Ä¢ ${opt.type==="all"?"Kirim+Chiqim":(opt.type==="income"?"Kirim":"Chiqim")}`;

        docPdf.setFont("helvetica", "bold");
        docPdf.setFontSize(14);
        docPdf.text(title, 40, 46);

        docPdf.setFont("helvetica", "normal");
        docPdf.setFontSize(10);
        docPdf.text(subtitle, 40, 64);

        docPdf.setFontSize(11);
        docPdf.text(`Jami kirim: ${nf.format(summary.income)} so'm`, 40, 92);
        docPdf.text(`Jami chiqim: ${nf.format(summary.expense)} so'm`, 40, 110);
        docPdf.text(`Balans: ${nf.format(summary.balance)} so'm`, 40, 128);
        docPdf.text(`Yozuvlar: ${summary.count}`, 40, 146);

        let startY = 170;

        if(opt.includeDetails && details.length){
          const body = details.map(r=>[
            r.date || "",
            r.type==="income" ? "Kirim" : "Chiqim",
            r.category || "Boshqa",
            r.note || "",
            nf.format(r.amount || 0),
          ]);

          docPdf.autoTable({
            startY,
            head: [["Sana","Turi","Kategoriya","Izoh","Summa (so'm)"]],
            body,
            styles: { fontSize: 9, cellPadding: 6 },
            headStyles: { fontStyle: "bold" },
            columnStyles: { 4: { halign: "right" } }
          });
        } else {
          docPdf.setFontSize(10);
          docPdf.text("Detallar o‚Äòchirilgan (yoki limit 0).", 40, startY);
        }

        const filename = `kirim-chiqim-hisobot_${(opt.from||"all")}_${(opt.to||"all")}.pdf`;
        docPdf.save(filename);
        toast("PDF saqlandi.");
      }catch(e){
        console.error(e);
        toast("PDF yaratishda xato. Internet/diapazon tekshiring.");
      }
    }

    // ====== CRUD ======
    async function addOrUpdateTx(payload){
      if(!currentUser) return;

      if(editingId){
        const ref = doc(db, "users", currentUser.uid, "transactions", editingId);
        await updateDoc(ref, payload);
      }else{
        await addDoc(txCol(), { ...payload, createdAt: serverTimestamp() });
      }
    }

    async function deleteTx(id){
      if(!currentUser) return;
      await deleteDoc(doc(db, "users", currentUser.uid, "transactions", id));
    }

    async function clearAllTx(){
      // Batch delete (500 limit per batch)
      if(!currentUser) return;
      const ok = confirm("Hamma yozuvlarni o‚Äòchirasizmi? Bu amal qaytarilmaydi.");
      if(!ok) return;

      btnClearAll.disabled = true;
      try{
        toast("O‚Äòchirilmoqda‚Ä¶", 2000);
        let deleted = 0;

        while(true){
          const snap = await getDocs(query(txCol(), limit(500)));
          if(snap.empty) break;

          const batch = writeBatch(db);
          snap.docs.forEach(d=> batch.delete(d.ref));
          await batch.commit();

          deleted += snap.size;
          if(snap.size < 500) break;
        }

        toast(`O‚Äòchirildi: ${deleted} ta`);
      }catch(e){
        console.error(e);
        toast("O‚Äòchirishda xato. Rules/Internet tekshiring.");
      }finally{
        btnClearAll.disabled = false;
      }
    }

    function startEdit(id){
      const r = listDocs.find(x=>x.id===id);
      if(!r) return;

      editingId = id;
      entryForm.querySelector(`input[name="type"][value="${r.type}"]`).checked = true;
      amountEl.value = r.amount ?? "";
      dateEl.value = r.date ?? todayStr();
      categoryEl.value = r.category ?? "";
      noteEl.value = r.note ?? "";
      btnCancelEdit.hidden = false;
      $("btnSave").querySelector("span:last-child").textContent = "Yangilash";
      toast("Tahrir rejimi.");
      window.scrollTo({ top: 0, behavior: "smooth" });
    }

    function cancelEdit(){
      editingId = null;
      entryForm.reset();
      dateEl.value = todayStr();
      btnCancelEdit.hidden = true;
      $("btnSave").querySelector("span:last-child").textContent = "Saqlash";
    }

    // ====== CSV (simple) ======
    function rowsToCsv(rows){
      const header = ["date","type","category","note","amount"];
      const escapeCsv = (v)=>{
        const s = String(v ?? "");
        if(/[",\n]/.test(s)) return `"${s.replace(/"/g,'""')}"`;
        return s;
      };
      const lines = [header.join(",")];
      for(const r of rows){
        lines.push([
          r.date||"",
          r.type||"",
          r.category||"",
          r.note||"",
          String(r.amount||0),
        ].map(escapeCsv).join(","));
      }
      return lines.join("\n");
    }

    function downloadText(filename, text){
      const blob = new Blob([text], { type: "text/plain;charset=utf-8" });
      const url = URL.createObjectURL(blob);
      const a = document.createElement("a");
      a.href = url;
      a.download = filename;
      document.body.appendChild(a);
      a.click();
      a.remove();
      URL.revokeObjectURL(url);
    }

    async function exportCsv(){
      const rows = applyClientFilters(listDocs);
      const csv = rowsToCsv(rows);
      downloadText(`kirim-chiqim_export_${todayStr()}.csv`, csv);
      toast("CSV yuklab olindi.");
    }

    function parseCsv(text){
      // minimal CSV parser supporting quoted values
      const rows = [];
      let i=0, field="", row=[], inQuotes=false;

      const pushField = ()=>{ row.push(field); field=""; };
      const pushRow = ()=>{ rows.push(row); row=[]; };

      while(i < text.length){
        const c = text[i];
        if(inQuotes){
          if(c === '"' && text[i+1] === '"'){ field += '"'; i += 2; continue; }
          if(c === '"'){ inQuotes=false; i++; continue; }
          field += c; i++; continue;
        }else{
          if(c === '"'){ inQuotes=true; i++; continue; }
          if(c === ","){ pushField(); i++; continue; }
          if(c === "\n"){ pushField(); pushRow(); i++; continue; }
          if(c === "\r"){ i++; continue; }
          field += c; i++; continue;
        }
      }
      pushField();
      if(row.length) pushRow();
      return rows;
    }

    async function importCsv(file){
      if(!file) return;
      const text = await file.text();
      const rows = parseCsv(text).filter(r=>r.length);
      if(!rows.length){ toast("CSV bo‚Äòsh."); return; }

      const header = rows[0].map(x=>String(x||"").trim().toLowerCase());
      const idx = (k)=> header.indexOf(k);

      const iDate = idx("date");
      const iType = idx("type");
      const iCat = idx("category");
      const iNote = idx("note");
      const iAmt = idx("amount");

      if([iDate,iType,iNote,iAmt].some(x=>x<0)){
        toast("CSV ustunlari noto‚Äòg‚Äòri. Kerak: date,type,category,note,amount");
        return;
      }

      const ok = confirm(`CSV import qilinsinmi? (${rows.length-1} ta yozuv)`);
      if(!ok) return;

      setCloudState("wait","Cloud: import‚Ä¶");
      try{
        let count = 0;
        for(let r=1; r<rows.length; r++){
          const row = rows[r];
          const type = (row[iType]||"").trim();
          const payload = {
            date: String(row[iDate]||"").trim(),
            type: type === "income" || type === "expense" ? type : "expense",
            category: String(row[iCat]||"Boshqa").trim() || "Boshqa",
            note: String(row[iNote]||"").trim() || "‚Äî",
            amount: parseAmount(row[iAmt]),
          };
          if(!payload.date || !Number.isFinite(payload.amount)) continue;
          await addDoc(txCol(), { ...payload, createdAt: serverTimestamp() });
          count++;
        }
        toast(`Import tugadi: ${count} ta`);
        setCloudState("ok","Cloud: ulandi");
      }catch(e){
        console.error(e);
        setCloudState("bad","Cloud: xato");
        toast("Importda xato. Rules/Internet tekshiring.");
      }finally{
        csvFile.value = "";
      }
    }

    // ====== Events ======
    // Fill fiscalStartDay options
    (function initFiscalOptions(){
      fiscalStartDay.innerHTML = "";
      for(let d=1; d<=28; d++){
        const opt = document.createElement("option");
        opt.value = String(d);
        opt.textContent = `${d}-kun`;
        if(d===1) opt.selected = true;
        fiscalStartDay.appendChild(opt);
      }
    })();

    dateEl.value = todayStr();

    useReportForCalc.addEventListener("change", ()=>{
      calcRangesBox.hidden = useReportForCalc.checked;
      refreshSummaryAndAnalysis(false);
    });

    btnRangeAll.addEventListener("click", ()=>{
      reportFrom.value = "";
      reportTo.value = "";
      attachRealtimeList();
      refreshSummaryAndAnalysis(true);
    });

    btnRangeThisMonth.addEventListener("click", ()=>{
      const r = getFiscalMonthRange(todayStr(), Number(fiscalStartDay.value||1));
      reportFrom.value = r.from;
      reportTo.value = r.to;
      attachRealtimeList();
      refreshSummaryAndAnalysis(true);
    });

    btnApplyRange.addEventListener("click", ()=>{
      attachRealtimeList();
      refreshSummaryAndAnalysis(true);
      toast("Diapazon qo‚Äòllandi.");
    });

    btnReload.addEventListener("click", ()=>{
      attachRealtimeList();
      toast("Yangilandi.");
    });

    btnLoadMore.addEventListener("click", loadMore);

    filterType.addEventListener("change", ()=> renderList(listDocs));
    filterCategory.addEventListener("input", ()=> renderList(listDocs));
    searchNote.addEventListener("input", ()=> renderList(listDocs));

    btnToggleAnalysis.addEventListener("click", async ()=>{
      analysisCard.classList.toggle("open");
      if(analysisCard.classList.contains("open")){
        await refreshSummaryAndAnalysis(false);
        window.scrollTo({ top: analysisCard.getBoundingClientRect().top + window.scrollY - 12, behavior: "smooth" });
      }
    });

    btnRefreshAnalysis.addEventListener("click", ()=> refreshSummaryAndAnalysis(true));

    btnQuickReport.addEventListener("click", renderReport);
    btnOpenReport.addEventListener("click", renderReport);

    btnCloseReport.addEventListener("click", closeReportModal);
    reportModal.addEventListener("click", (e)=>{
      if(e.target === reportModal) closeReportModal();
    });

    btnPrint.addEventListener("click", reportPrint);
    btnPdf.addEventListener("click", reportPdf);

    btnClearAll.addEventListener("click", clearAllTx);

    btnExportCsv.addEventListener("click", exportCsv);
    csvFile.addEventListener("change", (e)=> importCsv(e.target.files?.[0]));

    // Table actions (delegation)
    document.addEventListener("click", async (e)=>{
      const t = e.target;
      const editId = t?.dataset?.edit;
      const delId = t?.dataset?.del;

      if(editId){
        startEdit(editId);
      }
      if(delId){
        const ok = confirm("O‚Äòchirasizmi?");
        if(!ok) return;
        try{
          await deleteTx(delId);
          toast("O‚Äòchirildi.");
        }catch(err){
          console.error(err);
          toast("O‚Äòchirishda xato.");
        }
      }
    });

    btnCancelEdit.addEventListener("click", cancelEdit);

    entryForm.addEventListener("submit", async (e)=>{
      e.preventDefault();
      if(!currentUser) return;

      const type = entryForm.type.value;
      const amount = parseAmount(amountEl.value);
      const date = dateEl.value;
      const category = (categoryEl.value || "Boshqa").trim() || "Boshqa";
      const note = (noteEl.value || "").trim();

      if(!Number.isFinite(amount) || amount <= 0){
        toast("Summani to‚Äòg‚Äòri kiriting.");
        return;
      }
      if(!date){
        toast("Sana tanlang.");
        return;
      }
      if(!note){
        toast("Izoh yozing.");
        return;
      }

      const payload = { type, amount, date, category, note };

      $("btnSave").disabled = true;
      try{
        await addOrUpdateTx(payload);
        toast(editingId ? "Yangilandi." : "Saqlandi.");
        cancelEdit();
        // keep date = today by default
        dateEl.value = todayStr();
      }catch(err){
        console.error(err);
        toast("Saqlashda xato. Rules/Internet tekshiring.");
      }finally{
        $("btnSave").disabled = false;
      }
    });

    // Theme button (store in Firestore)
    btnTheme.addEventListener("click", async ()=>{
      const cur = document.documentElement.dataset.theme || "dark";
      const next = cur === "light" ? "dark" : "light";
      document.documentElement.dataset.theme = next;
      btnTheme.querySelector(".icon").textContent = next === "light" ? "‚òÄ" : "‚òæ";
      if(currentUser){
        try{ await saveProfileTheme(currentUser.uid, next); }catch(e){}
      }
    });

    // Logout
    btnLogout.addEventListener("click", async ()=>{
      await signOut(auth);
    });

    // ====== Auth flow (name+code) ======
    async function doLogin(isSignup){
      const name = (loginName.value || "").trim();
      const code = (loginCode.value || "").trim();
      const email = emailFromName(name);

      if(!email){
        toast("Ism noto‚Äòg‚Äòri. Harf/raqam bilan kiriting.");
        return;
      }
      if(code.length < 6){
        toast("Kod kamida 6 ta belgi bo‚Äòlsin.");
        return;
      }

      btnLogin.disabled = true;
      btnSignup.disabled = true;
      setCloudState("wait", "Cloud: auth‚Ä¶");

      try{
        if(isSignup){
          const cred = await createUserWithEmailAndPassword(auth, email, code);
          try{ await updateProfile(cred.user, { displayName: name }); }catch(e){}
          toast("Ro‚Äòyxatdan o‚Äòtildi.");
        }else{
          await signInWithEmailAndPassword(auth, email, code);
          toast("Kirdingiz.");
        }
      }catch(e){
        console.error(e);
        const msg = (e && e.code) ? e.code : "auth/error";

        if(isSignup && msg === "auth/email-already-in-use"){
          toast("Bu ism band. Kirish tugmasini bosing.");
        }else if(!isSignup && msg === "auth/invalid-credential"){
          toast("Ism yoki kod xato.");
        }else if(msg === "auth/network-request-failed"){
          toast("Internet muammo (network).");
        }else{
          toast("Auth xato: " + msg);
        }
        setCloudState("bad","Cloud: xato");
      }finally{
        btnLogin.disabled = false;
        btnSignup.disabled = false;
      }
    }

    btnLogin.addEventListener("click", ()=> doLogin(false));
    btnSignup.addEventListener("click", ()=> doLogin(true));

    // ====== Start app on auth state ======
    onAuthStateChanged(auth, async (user)=>{
      currentUser = user;

      if(!user){
        // logged out
        if(unsubList){ unsubList(); unsubList=null; }
        listDocs = []; lastDoc = null;
        renderList([]);
        overlay.classList.remove("hidden");
        appEl.style.display = "none";
        whoami.textContent = "üë§ ‚Äî";
        setCloudState("wait","Cloud: ulanmoqda‚Ä¶");
        return;
      }

      // logged in
      overlay.classList.add("hidden");
      appEl.style.display = "block";

      const display = user.displayName || normalizeName(loginName.value) || "user";
      whoami.textContent = `üë§ ${display}`;

      // load theme
      await loadProfileTheme(user.uid);
      btnTheme.querySelector(".icon").textContent = (document.documentElement.dataset.theme === "light") ? "‚òÄ" : "‚òæ";

      // default range: fiscal month (startDay)
      const r = getFiscalMonthRange(todayStr(), Number(fiscalStartDay.value||1));
      if(!reportFrom.value && !reportTo.value){
        reportFrom.value = r.from;
        reportTo.value = r.to;
      }

      // attach realtime list
      attachRealtimeList();

      // initial summary
      refreshSummaryAndAnalysis(false);
    });

  </script>
</body>
</html>
